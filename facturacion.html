<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Facturaci√≥n estilo Bookipi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7fafa;
      padding: 30px;
      color: #02535a;
    }
    h2 {
      text-align: center;
      color: #02535a;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    label {
      font-weight: bold;
      margin-top: 10px;
      display: block;
    }
    input, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 4px;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin-bottom: 15px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
    }
    th {
      background: #02535a;
      color: white;
    }
    tfoot td {
      font-weight: bold;
    }
    button {
      background: #02535a;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .total {
      text-align: right;
    }
  </style>
</head>
<body>

<div class="container">
  <h2>Factura Excursiones Delgado</h2>

<label>C√≥digo de Reserva</label>
<input type="text" id="codigoReserva" placeholder="Ej: ED-007-2025" />
<button onclick="cargarDesdeReserva()">üîç Buscar Reserva</button>

<label>Cliente</label>
<input type="text" id="cliente" placeholder="Ej: Juan P√©rez" />

  <label>Correo</label>
  <input type="email" id="correo" placeholder="cliente@email.com" />

  <label>Fecha</label>
  <input type="date" id="fecha" />

  <h3>Art√≠culos</h3>
  <table id="tablaArticulos">
    <thead>
      <tr>
        <th>Descripci√≥n</th>
        <th>Cantidad</th>
        <th>Precio ($)</th>
        <th>Importe</th>
        <th>Acci√≥n</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr>
        <td colspan="3" class="total">Total:</td>
        <td id="totalFactura">$0.00</td>
        <td></td>
      </tr>
    </tfoot>
  </table>

  <button onclick="agregarArticulo()">‚ûï Agregar Art√≠culo</button>

  <label>Nota</label>
  <textarea id="nota" rows="3" placeholder="Gracias por su compra. Para consultas +506 6132 8183"></textarea>

  <button onclick="guardarFactura()">üíæ Guardar Factura</button>
  <p id="mensaje" style="margin-top: 15px; font-weight: bold;"></p>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDUEZgkrW-3HbZu2BLej4v0mbDHZf2vRo8",
    authDomain: "tours-460717.firebaseapp.com",
    projectId: "tours-460717",
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let articulos = [];

  function agregarArticulo() {
    const fila = document.createElement('tr');
    fila.innerHTML = `
      <td><input type="text" placeholder="Ej. Tour Medell√≠n" onchange="actualizarImporte(this)"></td>
      <td><input type="number" min="1" value="1" onchange="actualizarImporte(this)"></td>
      <td><input type="number" min="0" step="0.01" value="0" onchange="actualizarImporte(this)"></td>
      <td class="importe">$0.00</td>
      <td><button onclick="this.closest('tr').remove(); calcularTotal()">‚ùå</button></td>
    `;
    document.querySelector("#tablaArticulos tbody").appendChild(fila);
    calcularTotal();
  }

  function actualizarImporte(elemento) {
    const fila = elemento.closest('tr');
    const cantidad = parseFloat(fila.children[1].children[0].value) || 0;
    const precio = parseFloat(fila.children[2].children[0].value) || 0;
    const importe = cantidad * precio;
    fila.children[3].textContent = `$${importe.toFixed(2)}`;
    calcularTotal();
  }

  function calcularTotal() {
    let total = 0;
    document.querySelectorAll("#tablaArticulos tbody tr").forEach(fila => {
      const cantidad = parseFloat(fila.children[1].children[0].value) || 0;
      const precio = parseFloat(fila.children[2].children[0].value) || 0;
      total += cantidad * precio;
    });
    document.getElementById("totalFactura").textContent = `$${total.toFixed(2)}`;
  }

  async function guardarFactura() {
    const cliente = document.getElementById("cliente").value.trim();
    const correo = document.getElementById("correo").value.trim();
    const fecha = document.getElementById("fecha").value;
    const nota = document.getElementById("nota").value;
    const total = document.getElementById("totalFactura").textContent.replace('$', '');

    if (!cliente || !correo || !fecha) {
      alert("Por favor completa todos los campos obligatorios.");
      return;
    }

    const articulos = [];
    document.querySelectorAll("#tablaArticulos tbody tr").forEach(fila => {
      const descripcion = fila.children[0].children[0].value;
      const cantidad = parseFloat(fila.children[1].children[0].value) || 0;
      const precio = parseFloat(fila.children[2].children[0].value) || 0;
      const importe = cantidad * precio;
      if (descripcion && cantidad && precio) {
        articulos.push({ descripcion, cantidad, precio, importe });
      }
    });

    if (articulos.length === 0) {
      alert("Debes agregar al menos un art√≠culo.");
      return;
    }

    const factura = {
      cliente,
      correo,
      fecha,
      nota,
      total: parseFloat(total),
      estado: "Pendiente",
      articulos,
      creada: new Date()
    };

    try {
      await db.collection("facturas").add(factura);
      document.getElementById("mensaje").textContent = "‚úÖ Factura guardada correctamente.";
    } catch (e) {
      console.error("Error al guardar:", e);
      document.getElementById("mensaje").textContent = "‚ùå Error al guardar la factura.";
    }
  }

  async function cargarDesdeReserva() {
  const codigo = document.getElementById("codigoReserva").value.trim();
  if (!codigo) {
    alert("Por favor ingresa un c√≥digo de reserva.");
    return;
  }

  try {
    const doc = await db.collection("reservas").doc(codigo).get();
    if (!doc.exists) {
      alert("‚ùå No se encontr√≥ la reserva.");
      return;
    }

    const data = doc.data();
    document.getElementById("cliente").value = data.nombreTitular || "";
    document.getElementById("correo").value = data.correo || "";
    document.getElementById("fecha").value = new Date().toISOString().split("T")[0];

    // Agregar destino como l√≠nea de art√≠culo
    const tbody = document.querySelector("#tablaArticulos tbody");
    tbody.innerHTML = ""; // limpiar

    const cantidad = (parseInt(data.cantidadAdultos || 0) + parseInt(data.cantidadNinos || 0)) || 1;
    const precioUnitario = parseFloat(data.total || 0) / cantidad;

    const fila = document.createElement("tr");
    fila.innerHTML = `
      <td><input type="text" value="${data.destino || 'Paquete Tur√≠stico'}"></td>
      <td><input type="number" value="${cantidad}"></td>
      <td><input type="number" value="${precioUnitario.toFixed(2)}"></td>
      <td class="importe">$${data.total?.toFixed(2) || "0.00"}</td>
      <td><button onclick="this.closest('tr').remove(); calcularTotal()">‚ùå</button></td>
    `;
    tbody.appendChild(fila);
    calcularTotal();

  } catch (e) {
    console.error("Error al buscar reserva:", e);
    alert("‚ùå Ocurri√≥ un error al cargar la reserva.");
  }
}
  async function cargarDesdeReserva() {
  const codigo = document.getElementById("codigoReserva").value.trim();
  if (!codigo) {
    alert("Por favor ingresa un c√≥digo de reserva.");
    return;
  }

  try {
    const doc = await db.collection("reservas").doc(codigo).get();
    if (!doc.exists) {
      alert("‚ùå No se encontr√≥ la reserva.");
      return;
    }

    const data = doc.data();
    document.getElementById("cliente").value = data.nombreTitular || "";
    document.getElementById("correo").value = data.correo || "";
    document.getElementById("fecha").value = new Date().toISOString().split("T")[0];

    // Agregar destino como l√≠nea de art√≠culo
    const tbody = document.querySelector("#tablaArticulos tbody");
    tbody.innerHTML = ""; // limpiar

    const cantidad = (parseInt(data.cantidadAdultos || 0) + parseInt(data.cantidadNinos || 0)) || 1;
    const precioUnitario = parseFloat(data.total || 0) / cantidad;

    const fila = document.createElement("tr");
    fila.innerHTML = `
      <td><input type="text" value="${data.destino || 'Paquete Tur√≠stico'}"></td>
      <td><input type="number" value="${cantidad}"></td>
      <td><input type="number" value="${precioUnitario.toFixed(2)}"></td>
      <td class="importe">$${data.total?.toFixed(2) || "0.00"}</td>
      <td><button onclick="this.closest('tr').remove(); calcularTotal()">‚ùå</button></td>
    `;
    tbody.appendChild(fila);
    calcularTotal();

  } catch (e) {
    console.error("Error al buscar reserva:", e);
    alert("‚ùå Ocurri√≥ un error al cargar la reserva.");
  }
}

</script>
</body>
</html>

