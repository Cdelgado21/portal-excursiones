<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Facturaci√≥n estilo Bookipi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7fafa;
      padding: 30px;
      color: #02535a;
    }
    h2 {
      text-align: center;
      color: #02535a;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    label {
      font-weight: bold;
      margin-top: 10px;
      display: block;
    }
    input, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 4px;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin-bottom: 15px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
    }
    th {
      background: #02535a;
      color: white;
    }
    tfoot td {
      font-weight: bold;
    }
    button {
      background: #02535a;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .total {
      text-align: right;
    }
  </style>
</head>
<body>

<div class="container">
  <h2>Factura Excursiones Delgado</h2>

<label>C√≥digo de Reserva</label>
<input type="text" id="codigoReserva" placeholder="Ej: ED-007-2025" />
<button onclick="cargarDesdeReserva()">üîç Buscar Reserva</button>

<label>Cliente</label>
<input type="text" id="cliente" placeholder="Ej: Juan P√©rez" />

<label>Correo</label>
<input type="email" id="correo" placeholder="cliente@email.com" />

<label>Tel√©fono</label>
<input type="tel" id="telefono" placeholder="Ej. +506 6132 8183" />

  <label>Fecha</label>
  <input type="date" id="fecha" />

  <h3>Art√≠culos</h3>
  <table id="tablaArticulos">
    <thead>
      <tr>
        <th>Descripci√≥n</th>
        <th>Cantidad</th>
        <th>Precio ($)</th>
        <th>Importe</th>
        <th>Acci√≥n</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr>
        <td colspan="3" class="total">Total:</td>
        <td id="totalFactura">$0.00</td>
        <td></td>
        <div id="abonos" style="margin-top: 20px; background: #f5f5f5; padding: 10px; border-radius: 8px;"></div>
      </tr>
    </tfoot>
  </table>

  <button onclick="agregarArticulo()">‚ûï Agregar Art√≠culo</button>

  <label>Nota</label>
  <textarea id="nota" rows="3" placeholder="Gracias por su compra. Para consultas +506 6132 8183"></textarea>

  <button onclick="guardarFactura()">üíæ Guardar Factura</button>
  <p id="mensaje" style="margin-top: 15px; font-weight: bold;"></p>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDUEZgkrW-3HbZu2BLej4v0mbDHZf2vRo8",
    authDomain: "tours-460717.firebaseapp.com",
    projectId: "tours-460717",
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  async function cargarDesdeReserva() {
    const codigo = document.getElementById("codigoReserva").value.trim();
    if (!codigo) return alert("Escribe un c√≥digo de reserva");

    try {
      const doc = await db.collection("reservas").doc(codigo).get();
      if (!doc.exists) return alert("No se encontr√≥ la reserva");

      const data = doc.data();
      document.getElementById("cliente").value = data.nombreTitular || "";
      document.getElementById("correo").value = data.correo || "";
      document.getElementById("telefono").value = data.telefono || "";
      document.getElementById("fecha").value = data.fechaReserva || "";

      const total = parseFloat(data.total || 0);
      const pagos = data.pagos || [];

      // Mostrar art√≠culo principal
      agregarFilaArticulo(data.destino || "Tour", 1, total.toFixed(2));

      // Mostrar abonos
      mostrarAbonos(pagos, total);

    } catch (e) {
      console.error("Error cargando reserva:", e);
      alert("Error al cargar la reserva");
    }
  }

  function agregarFilaArticulo(descripcion, cantidad, precio) {
    const tabla = document.getElementById("tablaArticulos").getElementsByTagName("tbody")[0];
    const fila = tabla.insertRow();

    fila.innerHTML = `
      <td>${formatearTexto(descripcion)}</td>
      <td>${cantidad}</td>
      <td>$${parseFloat(precio).toFixed(2)}</td>
      <td>$${(cantidad * parseFloat(precio)).toFixed(2)}</td>
      <td><button onclick="this.closest('tr').remove()">‚ùå</button></td>
    `;
    actualizarTotalFactura();
  }

  function mostrarAbonos(pagos, total) {
    const abonosDiv = document.getElementById("abonos");
    let abonado = pagos.reduce((sum, p) => sum + parseFloat(p.monto || 0), 0);

    abonosDiv.innerHTML = `
      <p><strong>Total del Tour:</strong> $${total.toFixed(2)}</p>
      <p><strong>Total Abonado:</strong> $${abonado.toFixed(2)}</p>
      <p><strong>Saldo Pendiente:</strong> $${(total - abonado).toFixed(2)}</p>
    `;
  }

  function actualizarTotalFactura() {
    let total = 0;
    const filas = document.querySelectorAll("#tablaArticulos tbody tr");
    filas.forEach(row => {
      const importe = row.children[3]?.textContent.replace("$", "") || "0";
      total += parseFloat(importe);
    });
    document.querySelector(".total").textContent = `Total: $${total.toFixed(2)}`;
  }

  function formatearTexto(texto) {
    return texto
      .replace(/_/g, " ")
      .replace(/\b\w/g, l => l.toUpperCase());
  }

</script>


</body>
</html>

