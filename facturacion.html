<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Factura de Reserva</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f0f7f7;
    margin: 0;
    padding: 20px;
  }

  .factura {
    background: white;
    padding: 25px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    max-width: 900px;
    margin: auto;
  }

  .encabezado {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .encabezado img {
    height: 250px;
  }

  h2 {
    text-align: center;
    color: #02535a;
    margin-top: 10px;
    margin-bottom: 5px;
  }

  .subinfo {
    text-align: center;
    color: #333;
    font-size: 14px;
    margin-bottom: 20px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }

  th, td {
    padding: 10px;
    border: 1px solid #ccc;
  }

  th {
    background: #f0f0f0;
    color: #02535a;
  }

  .acciones {
    text-align: center;
    margin-top: 30px;
  }

  .acciones button {
    padding: 10px 20px;
    background-color: #02535a;
    color: white;
    border: none;
    border-radius: 6px;
    margin: 0 10px;
    cursor: pointer;
  }

  /* MODAL TRANSACTIONS */
  #modalTransacciones {
    display: none; /* importante */
    position: fixed;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.4); /* fondo oscuro */
    z-index: 999;
    justify-content: center;
    align-items: center;
  }

  #modalTransacciones .modal-contenido {
    background: white;
    padding: 25px;
    border-radius: 10px;
    width: 90%;
    max-width: 900px;
    box-shadow: 0 0 20px rgba(0,0,0,0.2);
  }

  .modal-contenido h3 {
    margin-top: 0;
    color: #02535a;
  }

  .modal-contenido table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }

  .modal-contenido th,
  .modal-contenido td {
    padding: 10px;
    border: 1px solid #ddd;
    text-align: left;
  }

  .modal-contenido th {
    background-color: #02535a;
    color: white;
  }

  .modal-contenido tr:hover {
    background-color: #f7f7f7;
  }

  .modal-contenido button {
    background-color: #02535a;
    color: white;
    border: none;
    padding: 10px 16px;
    margin-left: 8px;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
  }

  .modal-contenido button:hover {
    background-color: #027d82;
  }

  .menu-container {
    position: relative;
    display: inline-block;
  }

  .menu-options {
    position: absolute;
    top: 35px;
    right: 0;
    background-color: white;
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 6px 10px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    z-index: 9999;
    display: none;
    min-width: 120px;
  }

  .menu-options button {
    display: block;
    width: 100%;
    background: none;
    border: none;
    padding: 6px;
    text-align: left;
    font-weight: bold;
    color: #02535a;
    cursor: pointer;
  }

  .menu-options button:hover {
    background-color: #f0f7f7;
  }

  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 15px;
    align-items: center;
  }

  .form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    color: #02535a;
  }

  .form-group input,
  .form-group textarea {
    width: 100%;
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 14px;
    box-sizing: border-box;
  }

  textarea {
    resize: vertical;
  }
  #modalAgregarPago {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}
  #modalAgregarPago .modal-contenido {
  background: white;
  padding: 25px;
  border-radius: 10px;
  width: 90%;
  max-width: 600px;
  box-shadow: 0 0 20px rgba(0,0,0,0.2);
}
  </style>
</head>
<body>
  <div class="factura">
    <!-- Encabezado -->
    <div class="encabezado">
      <img src="LOGO EXCURSIONES DELGADO ESMERALDA.png" alt="Logo Excursiones Delgado">
      <div style="text-align: right;">
        <h2>Factura de Reserva</h2>
        <p><strong style="color:#333;">Código de Reserva:</strong> <span id="codigoReserva" style="color:#02535a;">---</span></p>
        <p><strong style="color:#333;">Factura Nº:</strong> <span id="numeroFactura" style="color:#02535a;">---</span></p>
      </div>
    </div>

    <!-- Información del Cliente -->
    <div style="border: 1px solid #ccc; border-radius: 12px; padding: 20px; background: #f9f9f9; color: #02535a;">
      <div style="display: flex; justify-content: space-between; flex-wrap: wrap;">
        <div style="min-width: 300px;">
          <p style="font-size: 12px; color: #5f9296;">FACTURAR A</p>
          <p id="nombreCliente" style="font-size: 18px; font-weight: bold;">---</p>
          <p id="correoCliente">---</p>
          <p id="telefonoCliente">---</p>
        </div>
        <div style="min-width: 250px;">
        <p><strong>Fecha de Emisión:</strong> <span id="fechaEmisionSpan">---</span></p>
        <p><strong>Viaje Ida:</strong> <span id="fechaIda">---</span></p>
        <p><strong>Viaje Regreso:</strong> <span id="fechaRegreso">---</span></p>
        <p><strong>Código Vuelo:</strong> <span id="codigoVuelo">---</span></p>
      </div>
    </div>

    <!-- Tabla -->
    <table>
      <thead>
        <tr>
          <th>Artículo</th>
          <th style="text-align:right;">Precio</th>
          <th style="text-align:center;">Cantidad</th>
          <th style="text-align:right;">Importe</th>
        </tr>
      </thead>
      <tbody id="tablaArticulos">
        <!-- JS -->
      </tbody>
      <tfoot>
        <tr><td colspan="3" style="text-align:right;">Subtotal</td><td style="text-align:right;" id="subtotal">$0.00</td></tr>
        <tr><td colspan="3" style="text-align:right;">IVA (0%)</td><td style="text-align:right;">$0.00</td></tr>
        <tr><td colspan="3" style="text-align:right;"><strong>Total</strong></td><td style="text-align:right;" id="total"><strong>$0.00</strong></td></tr>
      </tfoot>
    </table>
<h3 style="margin-top: 30px;">Pagos Aplicados</h3>
<table id="tablaPagos" border="1" cellpadding="8" cellspacing="0" style="width:100%; margin-bottom: 20px;">
  <thead style="background-color: #02535a; color: white;">
    <tr>
      <th>Pago</th>
      <th>Monto</th>
      <th>Fecha</th>
   <th>Método</th>
      <th>Nota</th>
    </tr>
  </thead>
  <tbody>
    <!-- Aquí se insertan dinámicamente las filas -->
  </tbody>
</table>
    <!-- Botones -->
    <div class="acciones">
      <button onclick="mostrarTransaccionesModal()">Ver transacciones</button>
      <button onclick="guardarFactura()">Guardar Factura</button>
    </div>
  </div>

<div id="modalTransacciones" class="modal" style="display: none;">
  <div class="modal-contenido">
    <h3>Transacciones Registradas</h3>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Monto</th>
          <th>Fecha</th>
          <th>Método</th>
          <th>Nota</th>
        </tr>
      </thead>
      <tbody id="tablaTransaccionesBody">
        <!-- Aquí se cargan las transacciones -->
      </tbody>
    </table>

    <div style="text-align:right; margin-top: 20px;">
      <button onclick="abrirModalAgregarPago()">Agregar Pago</button>
      <button onclick="cerrarModal('modalTransacciones')" style="background-color: #999;">Cerrar</button>
    </div>
  </div>
</div>

<div id="modalAgregarPago" style="display: none;">
  <div class="modal-contenido">
    <h3>Agregar Nuevo Pago</h3>
    <div class="form-grid">
      <div class="form-group">
        <label>Monto:</label>
        <input type="number" id="nuevoMonto" />
      </div>
      <div class="form-group">
        <label>Fecha:</label>
        <input type="date" id="nuevaFecha" />
      </div>
     <label for="nuevoMetodo">Método de Pago</label>
<select id="nuevoMetodo" style="width: 100%; padding: 8px; margin: 8px 0;">
  <option value="Transferencia">Transferencia</option>
  <option value="Efectivo">Efectivo</option>
  <option value="Tarjeta">Tarjeta</option>
  <option value="Sin especificar">Sin especificar</option>
</select>
      <div class="form-group" style="grid-column: 1 / -1;">
        <label>Nota:</label>
        <textarea id="nuevaNota"></textarea>
      </div>
    </div>
    <div style="margin-top: 20px; text-align: right;">
      <button onclick="guardarPago()">Guardar</button>
      <button onclick="cerrarModalAgregaPago()">Cancelar</button>
    </div>
  </div>
</div>
<script>
  // Configuración de Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyDUEZgkrW-3HbZu2BLej4v0mbDHZf2vRo8",
    authDomain: "tours-460717.firebaseapp.com",
    projectId: "tours-460717",
    storageBucket: "tours-460717.appspot.com",
    messagingSenderId: "1000749333444",
    appId: "1:1000749333444:web:73437891b59a96b6a4c291"
  };
let data = {}
  // Inicializar Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  function formatearFecha(fechaISO) {
  const fecha = new Date(fechaISO);
  const dia = String(fecha.getDate()).padStart(2, '0');
  const mes = String(fecha.getMonth() + 1).padStart(2, '0');
  const año = fecha.getFullYear();
  return `${dia}/${mes}/${año}`;
}
  // Función segura para insertar texto
  function setTexto(id, valor) {
    const elemento = document.getElementById(id);
    if (elemento) {
      elemento.textContent = valor || "---";
    }
  }

// Obtener el ID de la reserva desde la URL
const urlParams = new URLSearchParams(window.location.search);
const reservaID = urlParams.get("reserva");

if (reservaID) {
  db.collection("reservas").doc(reservaID).get().then((doc) => {
    if (doc.exists) {
      const data = doc.data();
console.log("Data cargada:", data);
console.log("Precios:", data.pasajeros);
      console.log("Destino:", data.destino);
console.log("Adultos:", data.cantidadAdultos);
console.log("Niños:", data.cantidadNinos);
console.log("Bebés:", data.cantidadBebes);

console.log("Precio Adulto:", data.pasajeros?.precioAdulto);
console.log("Precio Niño:", data.pasajeros?.precioNino);
console.log("Precio Bebé:", data.pasajeros?.precioBebe);
      // Formato local para fechas
      const formatoLocal = { day: '2-digit', month: '2-digit', year: 'numeric' };

      // Datos generales
      setTexto("codigoReserva", reservaID);
      setTexto("numeroFactura", "N/A");

      // Datos del cliente
      setTexto("nombreCliente", data.nombreTitular);
      setTexto("correoCliente", data.correo || "yullianagomez@gmail.com");
      setTexto("telefonoCliente", data.telefono || "85378012");

      // Fecha de emisión (ya viene lista)
      setTexto("fechaEmisionSpan", data.fechaReserva);

      // Fechas del vuelo (ida y regreso) con formato local
      if (data.vueloIda && data.vueloIda.fecha) {
        const fechaIda = new Date(data.vueloIda.fecha + 'T00:00:00');
        document.getElementById("fechaIda").innerText = fechaIda.toLocaleDateString('es-CR', formatoLocal);
      } else {
        setTexto("fechaIda", "---");
      }

      if (data.vueloRegreso && data.vueloRegreso.fecha) {
        const fechaRegreso = new Date(data.vueloRegreso.fecha + 'T00:00:00');
        document.getElementById("fechaRegreso").innerText = fechaRegreso.toLocaleDateString('es-CR', formatoLocal);
      } else {
        setTexto("fechaRegreso", "---");
      }

      // Código del vuelo
      setTexto("codigoVuelo", data.vueloIda?.codigo || "---");

const destino = data.destino;      // "super_promocion_medellin"
const adultos = Number(data.cantidadAdultos) || 0;
const ninos   = Number(data.cantidadNinos)   || 0;
const bebes   = Number(data.cantidadBebes)   || 0;

// --- precios TOMADOS DEL DOCUMENTO DE LA RESERVA ---
const precioAdulto = Number(data.precioAdulto) || 0;
const precioNino   = Number(data.precioNino)   || 0;
const precioBebe   = Number(data.precioBebe)   || 0;
      
// --- tabla ---
const tabla    = document.getElementById("tablaArticulos");
tabla.innerHTML = "";
let subtotal    = 0;

function agregarFila(descripcion, precio, cantidad) {
  if (cantidad > 0) {
    const importe = precio * cantidad;
    subtotal += importe;
    tabla.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${descripcion}</td>
        <td style="text-align:right;">$${precio.toFixed(2)}</td>
        <td style="text-align:center;">${cantidad}</td>
        <td style="text-align:right;">$${importe.toFixed(2)}</td>
      </tr>
    `);
  }
}

const nombreBonito = destino.replace(/_/g, " ").replace(/\b\w/g,l=>l.toUpperCase());

agregarFila(`${nombreBonito} - Adultos`, precioAdulto, adultos);
agregarFila(`${nombreBonito} - Niños`,   precioNino,   ninos);
agregarFila(`${nombreBonito} - Bebés`,   precioBebe,   bebes);

// totales
document.getElementById("subtotal").textContent = `$${subtotal.toFixed(2)}`;
document.getElementById("total").textContent    = `$${subtotal.toFixed(2)}`;
      
  } else {
        alert("Reserva no encontrada: " + reservaID);
      }
    })
    .catch((error) => {
      console.error("Error al obtener datos:", error);
      alert("Hubo un problema al cargar la reserva.");
    });
} else {
  alert("No se proporcionó un código de reserva.");
}
let indexEditando = null;

function toggleMenu(button) {
  // Cierra todos los menús primero
  document.querySelectorAll('.menu-options').forEach(menu => {
    if (menu !== button.nextElementSibling) {
      menu.style.display = 'none';
    }
  });
  const menu = button.nextElementSibling;
  menu.style.display = menu.style.display === "block" ? "none" : "block";
  document.addEventListener("click", function hideMenu(e) {
    if (!menu.contains(e.target) && e.target !== button) {
      menu.style.display = "none";
      document.removeEventListener("click", hideMenu);
    }
  });
}

async function mostrarTransaccionesModal() {
  const tabla = document.getElementById("tablaTransaccionesBody");
  const modal = document.getElementById("modalTransacciones");
  modal.style.display = "flex";
   tabla.innerHTML = "";

  const reservaId = new URLSearchParams(window.location.search).get("reserva");
  if (!reservaId) {
    alert("No se proporcionó un código de reserva.");
    return;
  }

  const docRef = await db.collection("reservas").doc(reservaId).get();
  const data = docRef.data();
  const transacciones = data.pagos || [];

  if (transacciones.length === 0) {
    tabla.innerHTML = `<tr><td colspan="6">No hay pagos registrados.</td></tr>`;
  } else {
    transacciones.forEach((pago, index) => {
      tabla.innerHTML += `
        <tr>
          <td>${index + 1}</td>
          <td>$${Number(pago.monto || 0).toFixed(2)}</td>
          <td>${pago.fecha ? formatearFecha(pago.fecha) : "-"}</td>
          <td>${pago.metodo || "Sin especificar"}</td>
          <td>${pago.nota || ""}</td>
          <td>
     <div class="menu-container">
              <button class="menu-btn" onclick="toggleMenu(this)">⋮</button>
              <div class="menu-options">
                <button onclick="editarPago(${index})">Editar</button>
                <button onclick="eliminarPago(${index})">Eliminar</button>
              </div>
            </div>
          </td>
        </tr>
      `;
    });
  }
}
function abrirModal(id) {
  const modal = document.getElementById(id);
  if (modal) modal.style.display = "flex";
}

function cerrarModal(id) {
  const modal = document.getElementById(id);
  if (modal) modal.style.display = "none";
}

function editarPago(index) {
  const reservaId = new URLSearchParams(window.location.search).get("reserva");
  db.collection("reservas").doc(reservaId).get().then((doc) => {
    const pagos = doc.data().pagos || [];
    const pago = pagos[index];

    document.getElementById("nuevoMonto").value = pago.monto;
    document.getElementById("nuevaFecha").value = pago.fecha;
  document.getElementById("nuevoMetodo").value = pago.metodo || "Sin especificar";
    document.getElementById("nuevaNota").value = pago.nota;

    indexEditando = index;
    document.getElementById("modalAgregarPago").style.display = "flex";
  });
}

function guardarPago() {
  const monto = parseFloat(document.getElementById("nuevoMonto").value) || 0;
  const fecha = document.getElementById("nuevaFecha").value || "";
  const importe = parseFloat(document.getElementById("nuevoImporte").value) || monto;
  const nota = document.getElementById("nuevaNota").value || "";

  const metodo = document.getElementById("nuevoMetodo").value || "Sin especificar";
const nuevoPago = { monto, fecha, metodo, nota };

  const reservaId = new URLSearchParams(window.location.search).get("reserva");
  const docRef = db.collection("reservas").doc(reservaId);

  docRef.get().then((doc) => {
    let pagos = doc.data().pagos || [];

    if (indexEditando !== null) {
      pagos[indexEditando] = nuevoPago;
      indexEditando = null;
    } else {
      pagos.push(nuevoPago);
    }

    docRef.update({ pagos }).then(() => {
      cerrarModal("modalAgregarPago");
      mostrarTransaccionesModal();
    });
  });
}
 function abrirModalAgregarPago() {
  indexEditando = null;
  document.getElementById("nuevoMonto").value = "";
  document.getElementById("nuevaFecha").value = "";
  document.getElementById("nuevoImporte").value = "";
  document.getElementById("nuevaNota").value = "";
  document.getElementById("modalAgregarPago").style.display = "flex"; // <- corregido aquí
}
function cerrarModalAgregaPago() {
  document.getElementById("modalAgregarPago").style.display = "none";
}
function eliminarPago(index) {
  if (!confirm("¿Deseas eliminar este pago?")) return;

  const reservaId = new URLSearchParams(window.location.search).get("reserva");
  const docRef = db.collection("reservas").doc(reservaId);

  docRef.get().then((doc) => {
    let pagos = doc.data().pagos || [];
    pagos.splice(index, 1);
    docRef.update({ pagos }).then(() => {
      mostrarTransaccionesModal();
    });
  });
}
</script>

</body>
</html>
