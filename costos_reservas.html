<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Agregar Costos por Reserva</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f7f7;
      padding: 30px;
      color: #02535a;
    }

    h2 {
      background: #02535a;
      color: white;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
    }

    input {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .btn {
      background: #f49859;
      color: white;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      margin-top: 30px;
      cursor: pointer;
      width: 100%;
    }

    .resumen {
      background: white;
      padding: 20px;
      margin-top: 30px;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0,0,0,0.05);
    }

    .resumen strong {
      color: #02535a;
    }
  </style>
</head>
<body>
  <h2>ðŸ§¾ Agregar Costos a la Reserva</h2>

  <label for="codigo">CÃ³digo de Reserva</label>
  <input type="text" id="codigo" disabled />

  <label for="fecha">Fecha del viaje</label>
  <input type="date" id="fecha" disabled />

  <label for="venta">Venta total ($)</label>
  <input type="number" id="venta" disabled />

  <hr>

  <label for="boletos">Costo boletos aÃ©reos</label>
  <input type="number" id="boletos" />

  <label for="hospedaje">Costo hospedaje</label>
  <input type="number" id="hospedaje" />

  <label for="tours">Costo tours</label>
  <input type="number" id="tours" />

  <label for="otros">Otros costos</label>
  <input type="number" id="otros" />

  <label for="comision">ComisiÃ³n (%)</label>
  <input type="number" id="comision" />

  <div class="resumen">
    <p><strong>Total de costos:</strong> <span id="costoTotal">0</span></p>
    <p><strong>Ganancia estimada:</strong> <span id="gananciaEstimada">0</span></p>
  </div>

  <button class="btn" onclick="guardarCostos()">Guardar costos proyectados</button>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDUEZgkW-3HbZu2BLej4v0mbDHZf2vRo8",
      authDomain: "tours-460717.firebaseapp.com",
      projectId: "tours-460717"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const params = new URLSearchParams(window.location.search);
    const codigo = params.get("reserva"); // debe venir como ?reserva=ED-058-2025

    const input = id => document.getElementById(id);

    let ventaTotal = 0;

    async function cargarDatos() {
      const doc = await db.collection("costos_reservas").doc(codigo).get();
      if (doc.exists) {
        const d = doc.data();
        input("codigo").value = d.codigo;
        input("fecha").value = d.fecha_viaje;
        input("venta").value = d.venta_total;
        ventaTotal = d.venta_total;

        input("boletos").value = d.boletos || 0;
        input("hospedaje").value = d.hospedaje || 0;
        input("tours").value = d.tours || 0;
        input("otros").value = d.otros || 0;
        input("comision").value = d.comision || 0;

        calcularResumen();
      }
    }

    function calcularResumen() {
      const boletos = parseFloat(input("boletos").value) || 0;
      const hospedaje = parseFloat(input("hospedaje").value) || 0;
      const tours = parseFloat(input("tours").value) || 0;
      const otros = parseFloat(input("otros").value) || 0;
      const comision = parseFloat(input("comision").value) || 0;

      const totalCostos = boletos + hospedaje + tours + otros + (ventaTotal * (comision / 100));
      const ganancia = ventaTotal - totalCostos;

      document.getElementById("costoTotal").innerText = totalCostos.toFixed(2);
      document.getElementById("gananciaEstimada").innerText = ganancia.toFixed(2);
    }

    document.querySelectorAll("input").forEach(i => {
      i.addEventListener("input", calcularResumen);
    });

    async function guardarCostos() {
      await db.collection("costos_reservas").doc(codigo).update({
        boletos: parseFloat(input("boletos").value) || 0,
        hospedaje: parseFloat(input("hospedaje").value) || 0,
        tours: parseFloat(input("tours").value) || 0,
        otros: parseFloat(input("otros").value) || 0,
        comision: parseFloat(input("comision").value) || 0,
        actualizado_el: new Date()
      });
      alert("âœ… Costos guardados correctamente.");
      window.location.href = "costos_reservas.html";
    }

    window.onload = cargarDatos;
  </script>
</body>
</html>
