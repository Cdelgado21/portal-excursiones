<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Detalle de Reserva</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f7f7;
      color: #02535a;
      margin: 0;
      padding: 20px;
    }
    h2 {
      background-color: #02535a;
      color: white;
      padding: 10px;
      border-radius: 8px;
    }
    section {
      background: white;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    input, select, textarea {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      background-color: #02535a;
      color: white;
      padding: 10px 20px;
      border: none;
      margin-top: 10px;
      border-radius: 6px;
      cursor: pointer;
    }
    .campoInput {
  width: 100%;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 6px;
}
    a.boton-igual {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 12px 20px;
  background-color: #02535a;
  color: white;
  font-weight: bold;
  border-radius: 6px;
  text-decoration: none;
  font-size: 16px;
  height: 44px; /* igual a la altura del bot√≥n */
  box-sizing: border-box;
}
    .boton-principal {
  background-color: #02535a;
  color: white;
  padding: 12px 20px;
  border: none;
  border-radius: 10px;
  font-size: 16px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  text-decoration: none;
  min-width: 150px;
  flex: 1;
  max-width: 100%;
  height: 48px;
  white-space: nowrap;
  box-sizing: border-box;
}
  </style>
</head>
<body>

<h2>Detalle de Reserva</h2>

<section>
  <label for="codigoCotizacion">C√≥digo de Cotizaci√≥n</label>
  <input type="text" id="codigoCotizacion" placeholder="Ej: COT-003-2025">
  <button onclick="cargarDesdeCotizacion()">Cargar Informaci√≥n</button>
  <div id="infoCotizacion"></div>
</section>

<section>
  <h2>Informaci√≥n del Titular</h2>

  <!-- Fila 1 -->
  <div style="display: flex; gap: 20px; flex-wrap: wrap;">
    <div style="flex: 1; min-width: 250px;">
      <label for="nombreTitular">Nombre Completo</label>
      <input type="text" id="nombreTitular" placeholder="Ej. Mar√≠a Fern√°ndez Rodr√≠guez">
    </div>

    <div style="flex: 1; min-width: 250px;">
      <label for="cedulaTitular">C√©dula o Pasaporte</label>
      <input type="text" id="cedulaTitular" placeholder="Ej. 012345678">
    </div>
    
  </div>
  <!-- Fila 2 -->
  <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-top: 15px;">
    <div style="flex: 1; min-width: 250px;">
      <label for="vencimientoPasaporteTitular">Fecha de Vencimiento del Pasaporte</label>
      <input type="date" id="vencimientoPasaporteTitular">
    </div>

<div style="flex: 1; min-width: 250px;">
  <label for="fechaNacimientoTitular">Fecha de Nacimiento</label>
  <div style="display: flex; align-items: center; gap: 10px;">
    <input type="date" id="fechaNacimientoTitular" onchange="mostrarEdadTitular()">
    <span id="edadTitular" style="font-weight: bold; white-space: nowrap;">Edad: -</span>
  </div>
  </div>
</div>

 <!-- Fila 3 -->
<div style="display: flex; gap: 20px; flex-wrap: wrap; margin-top: 15px;">
  <div style="flex: 1; min-width: 250px;">
    <label for="correoTitular">Correo Electr√≥nico</label>
    <input type="email" id="correoTitular" placeholder="Ej. maria@email.com" style="width: 100%;">
  </div>

  <div style="flex: 1; min-width: 250px;">
    <label for="telefonoTitular">N√∫mero de Tel√©fono</label>
    <input type="tel" id="telefonoTitular" placeholder="Ej. 8888-8888" style="width: 100%;">
  </div>
 </div>
<div style="display: flex; gap: 20px; flex-wrap: wrap; margin-top: 15px;">

  <!-- Nacionalidad -->
  <div style="flex: 1; min-width: 250px;">
    <label for="nacionalidadTitular">Nacionalidad</label>
    <input type="text" id="nacionalidadTitular" placeholder="Ej. Costarricense" style="width: 100%;">
  </div>

  <!-- G√©nero -->
<div style="flex: 1; min-width: 180px;">
  <label for="generoTitular">G√©nero</label>
  <select id="generoTitular" style="width: 100%;">
    <option value="">Seleccione</option>
    <option value="Femenino">Femenino</option>
    <option value="Masculino">Masculino</option>

   </select>
</div>


</div>
</section>

<section>
  <h3>Pasajeros</h3>
  <div id="pasajerosContainer"></div>
  <button onclick="agregarPasajero()">Agregar Pasajero</button>
    <div id="pasajerosContainer" style="margin-top: 15px;"></div>
</section>

<section>

  <h2>Itinerario de Vuelos</h2>
  
<h3>Vuelo de Ida</h3>
<div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap; margin-bottom: 10px;">
  
  <!-- Aerol√≠nea -->
  <div style="display: flex; align-items: center; gap: 6px;">
    <label for="aerolineaIda">Aerol√≠nea:</label>
    <select id="aerolineaIda" style="min-width: 160px;">
      <option value="">Seleccione una</option>
      <option value="Avianca">Avianca</option>
      <option value="Volaris">Volaris</option>
      <option value="Copa Airlines">Copa Airlines</option>
      <option value="Wingo">Wingo</option>
    </select>
  </div>

  <!-- Fecha -->
  <div style="display: flex; align-items: center; gap: 6px;">
    <label for="fechaIda">Fecha:</label>
    <input type="date" id="fechaIda" style="min-width: 140px;">
  </div>

  <!-- N¬∞ de Vuelo -->
  <div style="display: flex; align-items: center; gap: 6px;">
    <label for="vueloIda" style="white-space: nowrap;">N¬∞ de Vuelo:</label>
    <input type="text" id="vueloIda" placeholder="Ej. AV637" style="min-width: 130px;">
  </div>
  <div style="display: flex; align-items: center; gap: 6px;">
  <label for="codigoBoletoIda" style="white-space: nowrap;">C√≥digo de Aerol√≠nea:</label>
  <input type="text" id="codigoBoletoIda" placeholder="Ej. AUC5TG" style="min-width: 160px;">
</div>

</div>


<label for="infoVueloIda">Informaci√≥n del Vuelo de Ida</label>
<textarea id="infoVueloIda" rows="3" placeholder="Ej. SJO ‚Üí PTY ‚Üí MDE, llegada 9:30 AM"></textarea>
<button id="btnAgregarVuelo" style="font-size: 12px; padding: 6px 12px;">‚ûï Agregar Vuelo Intermedio</button>
  </div>
  <div id="vuelosIntermediosContainer"></div>
  
 <h3>Vuelo de Regreso</h3>
<div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap; margin-bottom: 10px;">
  
  <!-- Aerol√≠nea -->
  <div style="display: flex; align-items: center; gap: 6px;">
    <label for="aerolineaRegreso">Aerol√≠nea:</label>
    <select id="aerolineaRegreso" style="min-width: 160px;">
      <option value="">Seleccione una</option>
      <option value="Avianca">Avianca</option>
      <option value="Volaris">Volaris</option>
      <option value="Copa Airlines">Copa Airlines</option>
      <option value="Wingo">Wingo</option>
    </select>
  </div>

  <!-- Fecha -->
  <div style="display: flex; align-items: center; gap: 6px;">
    <label for="fechaRegreso">Fecha:</label>
    <input type="date" id="fechaRegreso" style="min-width: 140px;">
  </div>

  <!-- N¬∞ de Vuelo -->
  <div style="display: flex; align-items: center; gap: 6px;">
    <label for="vueloRegreso" style="white-space: nowrap;">N¬∞ de Vuelo:</label>
    <input type="text" id="vueloRegreso" placeholder="Ej. AV637" style="min-width: 130px;">
  </div>
      <div style="display: flex; align-items: center; gap: 6px;">
   <label for="codigoBoletoRegreso" style="white-space: nowrap;">C√≥digo de Aerol√≠nea:</label>
  <input type="text" id="codigoBoletoRegreso" placeholder="Ej. AUC5TG" style="min-width: 160px;">
</div>

<label for="infoVueloRegreso">Informaci√≥n del Vuelo de Regreso</label>
<textarea id="infoVueloRegreso" rows="3" placeholder="Ej. MDE ‚Üí PTY ‚Üí SJO, llegada 6:45 PM"></textarea>
</div>
     <h3>Equipaje</h3>
       <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 10px;">
 <div style="flex: 1; min-width: 200px;">
      <label for="tipo_equipaje">Tipo de Equipaje</label>
      <select id="tipo_equipaje">
        <option value="">-- Seleccionar --</option>
        <option value="Art√≠culo personal">Art√≠culo personal</option>
        <option value="Maleta de mano">Maleta de mano de 10Kg</option>
        <option value="Maleta documentada">Maleta documentada de 23kg</option>
      </select>
    </div>

  <div style="flex: 1; min-width: 120px;">
      <label for="cantidad_equipaje">Cantidad</label>
      <input type="number" id="cantidad_equipaje" placeholder="Ej. 2">
    </div>
         
      <div style="flex: 1; min-width: 180px;">
      <label for="uso_equipaje">Uso</label>
      <select id="uso_equipaje">
        <option value="">-- Seleccionar --</option>
        <option value="Por persona">Por persona</option>
        <option value="Compartido">Compartido</option>
      </select>
    </div>
  </div>

 <button onclick="agregarEquipaje()" style="margin-bottom: 15px;">‚ûï Agregar equipaje</button>

  <label style="margin-top: 15px;">Resumen de Equipaje</label>
  <textarea id="equipaje" readonly rows="5" placeholder="Aqu√≠ aparecer√°n los tipos de equipaje agregados."></textarea>
</section>
<section style="margin-top: 30px;">
  <h2 style="background-color: #02535a; color: white; padding: 10px; border-radius: 8px;">Itinerario de Tours</h2>

  <!-- Fila 1: Destino y Duraci√≥n -->
  <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-top: 15px;">
    <div style="flex: 1; min-width: 250px;">
      <label><strong>Destino</strong></label>
      <select id="destino" onchange="cargarInfoTour(this.value)" style="width: 100%; padding: 8px;">
        <option value="">Seleccione un destino</option>
      </select>
    </div>
    <div style="flex: 1; min-width: 250px;">
      <label><strong>Duraci√≥n</strong></label>
      <input id="duracion" readonly placeholder="Ej. 5 d√≠as y 4 noches" style="width: 100%; padding: 8px;">
    </div>
  </div>
<!-- Bot√≥n Agregar hotel -->
<button onclick="abrirModalHotel()" style="margin-top: 15px; background-color: #02535a; color: white; border: none; padding: 10px 16px; border-radius: 8px;">
  ‚ûï Agregar Hotel
</button>

<!-- Tabla fuera del modal, en la p√°gina -->
<div id="hotelesResumenContainer" style="margin-top: 20px;">
  <h3>Hoteles</h3>
  <table id="tablaHoteles" style="width: 100%; border-collapse: collapse;">
    <thead style="background: #02535a; color: white;">
      <tr>
        <th>Hotel</th>
        <th>Check-in</th>
        <th>Check-out</th>
        <th>Tipo de Habitaci√≥n</th>
        <th>Cantidad</th>
        <th>Observaciones</th>
      </tr>
    </thead>
    <tbody id="tablaHotelesBody">
      <!-- Aqu√≠ se insertar√°n las filas -->
    </tbody>
  </table>
</div>
<div id="modalHotel" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.4); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:white; padding:30px; border-radius:12px; width:90%; max-width:600px; position:relative;">
    <h3 style="margin-top:0; color:#02535a;">Agregar Hotel</h3>

    <label>Nombre del Hotel</label>
<select id="modal_nombre_hotel" style="width:100%; margin-bottom:10px; padding:8px;">
  <option value="">Seleccione un hotel</option>
</select>

    <label>Hora Check-in</label>
   <input type="text" id="modal_checkin" placeholder="Ej. 03:00 PM">

    <label>Hora Check-out</label>
 <input type="text" id="modal_checkout" placeholder="Ej. 01:00 PM">

    <label>Tipo de habitaci√≥n</label>
    <select id="modal_tipoHabitacion_hotel" style="width:100%; margin-bottom:10px; padding:8px;">
      <option value="Doble">Doble</option>
      <option value="Triple">Triple</option>
      <option value="Cu√°druple">Cu√°druple</option>
    </select>

    <label>Cantidad</label>
    <input type="number" id="modal_cantidadHabitacion_hotel" placeholder="Ej. 2" style="width:100%; margin-bottom:10px; padding:8px;">

    <label>Observaciones</label>
    <textarea id="modal_observaciones_hotel" rows="3" placeholder="Ej. Vista al mar, habitaci√≥n conectada..." style="width:100%; padding:8px;"></textarea>

    <div style="margin-top:15px; text-align:right;">
      <button onclick="cerrarModalHotel()" style="margin-right:10px; background:#ccc; border:none; padding:8px 14px; border-radius:6px;">Cancelar</button>
      <button onclick="guardarHotelModal()" style="background:#02535a; color:white; border:none; padding:8px 16px; border-radius:6px;">Guardar</button>
    </div>
  </div>
</div>
    <!-- Fila 4: Itinerario -->
  <div style="margin-top: 20px;">
    <label for="itinerario"><strong>Itinerario</strong></label>
    <textarea id="itinerario" rows="4" placeholder="Ej. D√≠a 1 Llegada..." style="width: 100%; padding: 8px;"></textarea>
  </div>

  <!-- Fila 5: Tours Opcionales -->
  <div style="margin-top: 30px;">
    <label style="font-weight: bold;">Tours Opcionales</label>
    <div id="toursOpcionalesLista" style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px;"></div>
  </div>

  <!-- Observaciones -->
  <div style="margin-top: 15px;">
    <label><strong>Observaciones sobre Tours Opcionales</strong></label>
    <textarea id="obs_tours_opcionales" rows="2" placeholder="Ej: Solo adultos har√°n el tour de N√°poles. Ni√±os no participan en parapente." style="width: 100%; padding: 8px;"></textarea>
  </div>
</section>
<section style="margin-top: 30px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
  <h2 style="background-color: #02535a; color: white; padding: 10px; border-radius: 6px;">Resumen de Inversi√≥n</h2>
  <h3>Desglose por Adultos, Ni√±os o Beb√©s</h3>
  <!-- Cantidades -->
  <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-top: 15px;">
    <div style="flex: 1; min-width: 200px;">
      <label>Cantidad de Adultos</label>
      <input type="number" id="cantidadAdultos" value="0" oninput="calcularTotalGeneral()" class="campoInput">
    </div>
    <div style="flex: 1; min-width: 200px;">
      <label>Cantidad de Ni√±os</label>
      <input type="number" id="cantidadNinos" value="0" oninput="calcularTotalGeneral()" class="campoInput">
    </div>
    <div style="flex: 1; min-width: 200px;">
      <label>Cantidad de Beb√©s</label>
      <input type="number" id="cantidadBebes" value="0" oninput="calcularTotalGeneral()" class="campoInput">
    </div>
  </div>

  <!-- Precios -->
  <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-top: 15px;">
    <div style="flex: 1; min-width: 200px;">
      <label>Precio por Adulto</label>
      <input type="number" id="precioAdulto" value="0" oninput="calcularTotalGeneral()" class="campoInput">
    </div>
    <div style="flex: 1; min-width: 200px;">
      <label>Precio por Ni√±o</label>
      <input type="number" id="precioNino" value="0" oninput="calcularTotalGeneral()" class="campoInput">
    </div>
    <div style="flex: 1; min-width: 200px;">
      <label>Precio por Beb√©</label>
      <input type="number" id="precioBebe" value="0" oninput="calcularTotalGeneral()" class="campoInput">
    </div>
  </div>

  <!-- Total General -->
  <div style="margin-top: 15px;">
    <label><strong>Total General</strong></label>
    <input type="text" id="totalGeneral" readonly class="campoInput" style="background: #e0f7fa; font-weight: bold;">
  </div>

  <!-- Totales -->
  <div style="margin-top: 15px;">
    <p><strong>Total Pagado:</strong> $<span id="totalPagado">0</span></p>
    <input type="hidden" id="montoAbono" value="0">
    <p><strong>Saldo Pendiente:</strong> $<span id="saldoPendiente">0</span></p>
  </div>

  <section style="margin-top: 30px;">
  <h2 style="background-color: #02535a; color: white; padding: 10px; border-radius: 6px;">üí∞ Historial de Pagos</h2>

  <table style="width: 100%; margin-top: 20px; border-collapse: collapse;">
    <thead style="background-color: #f0f0f0;">
      <tr>
        <th style="padding: 10px;">Fecha</th>
        <th style="padding: 10px;">M√©todo</th>
        <th style="padding: 10px;">Monto</th>
        <th style="padding: 10px;">Nota</th>
      </tr>
    </thead>
    <tbody id="tablaHistorialPagos">
      <!-- Se insertan los pagos aqu√≠ -->
    </tbody>
  </table>

  <div style="text-align: right; margin-top: 20px;">
    <a id="btnFacturar" href="#" target="_blank" style="display:none; background-color: #02535a; color: white; padding: 10px 20px; border: none; border-radius: 8px; text-decoration: none; display: inline-block;">üìÑ Ver Factura</a>
  </div>
</section>

</section>
<div style="display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-end; margin-top: 20px;">
  <div style="flex: 1; min-width: 250px;">
    <label>Embajadora Responsable</label>
    <select id="embajadora" class="campoInput">
      <option value="">Seleccione</option>
      <option value="Yare">Yare</option>
      <option value="Yuliana">Yuliana</option>
      <option value="Tatiana">Tatiana</option>
      <option value="Geansury">Geansury</option>
      <option value="Marcela">Marcela</option>
      <option value="Cristopher">Cristopher</option>
    </select>
  </div>

  <div style="display: flex; gap: 12px; flex-wrap: wrap;">
    <button id="btnGuardarReserva" class="boton-principal">üíæ Guardar Reserva</button>
    <a id="btnCostos" target="_blank" href="#" class="boton-principal" style="display: none;">üíº Agregar Costos</a>
  </div>
</div>
<script>
const firebaseConfig = {
    apiKey: "AIzaSyDUEZgkrW-3HbZu2BLej4v0mbDHZf2vRo8",
    authDomain: "tours-460717.firebaseapp.com",
    projectId: "tours-460717",
    storageBucket: "tours-460717.firebasestorage.app",
    messagingSenderId: "1000749333444",
    appId: "1:1000749333444:web:73437891b59a96b6a4c291",
    measurementId: "G-CKZL71GV1W"
  };

  // Inicializar Firebase con compat
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const params = new URLSearchParams(window.location.search);
const codigoReservaExistente = params.get("codigo");
  
  async function generarCodigoReserva() {
    const a√±oActual = new Date().getFullYear();
    const counterRef = db.collection("counters").doc(`reserva-${a√±oActual}`);
    const counterDoc = await counterRef.get();

    let nuevoNumero = 1;
    if (counterDoc.exists) {
      nuevoNumero = counterDoc.data().ultimo || 0;
      nuevoNumero++;
    }
 console.log(">> NUEVO NUMERO GENERADO:", nuevoNumero);
    

    const codigo = `ED-${String(nuevoNumero).padStart(3, "0")}-${a√±oActual}`;
    await counterRef.set({ ultimo: nuevoNumero }, { merge: true });
    return { codigo, numero: nuevoNumero, a√±o: a√±oActual };
  }
async function guardarReserva() {
  try {
    let codigo = codigoReservaExistente;
    let numero = null;
    let a√±o = new Date().getFullYear();

    if (!codigo) {
      const generado = await generarCodigoReserva();
      codigo = generado.codigo;
      numero = generado.numero;
      a√±o = generado.a√±o;
    }

    if (!codigo || !a√±o) {
      alert("‚ö†Ô∏è No se pudo generar el c√≥digo de reserva. Intenta nuevamente.");
      return;
    }

    // Capturar datos
    const nombreTitular = document.getElementById("nombreTitular").value || "";
    const cedula = document.getElementById("cedulaTitular").value || "";
    const correo = document.getElementById("correoTitular").value || "";
    const telefono = document.getElementById("telefonoTitular").value || "";
    const fechaNacimientoTitular = document.getElementById("fechaNacimientoTitular").value || "";
    const vencimientoPasaporteTitular = document.getElementById("vencimientoPasaporteTitular").value || "";
    const nacionalidadTitular = document.getElementById("nacionalidadTitular").value || "";
    const generoTitular = document.getElementById("generoTitular").value || "";
    const fechaReserva = new Date().toISOString().split("T")[0];
    const destino = document.getElementById("destino").value || "";
    const total = parseFloat(document.getElementById("totalGeneral").value) || 0;
    const pagos = window.listaPagos || [];
    const abono = pagos.reduce((sum, p) => sum + p.monto, 0);
    const saldo = total - abono;
// üßÆ Guardar desglose de inversi√≥n
const cantidadAdultos = parseInt(document.getElementById("cantidadAdultos").value) || 0;
const cantidadNinos = parseInt(document.getElementById("cantidadNinos").value) || 0;
const cantidadBebes = parseInt(document.getElementById("cantidadBebes").value) || 0;

const precioAdulto = parseFloat(document.getElementById("precioAdulto").value) || 0;
const precioNino = parseFloat(document.getElementById("precioNino").value) || 0;
const precioBebe = parseFloat(document.getElementById("precioBebe").value) || 0;
    const embajadora = document.getElementById("embajadora").value || "";
    
    // Validaciones
    if (fechaNacimientoTitular && new Date(fechaNacimientoTitular) > new Date()) {
      alert("‚ö†Ô∏è La fecha de nacimiento debe ser anterior a hoy.");
      return;
    }

    if (vencimientoPasaporteTitular && new Date(vencimientoPasaporteTitular) < new Date()) {
      alert("‚ö†Ô∏è El pasaporte ya venci√≥. Por favor verificar o dejar en blanco si no se tiene.");
      return;
    }
    // Vuelo de Ida
const vueloIda = {
  aerolinea: document.getElementById("aerolineaIda")?.value || "",
  fecha: document.getElementById("fechaIda")?.value || "",
  vuelo: document.getElementById("vueloIda")?.value || "",
  codigo: document.getElementById("codigoBoletoIda")?.value || "",
  descripcion: document.getElementById("infoVueloIda")?.value || ""
};

// Vuelo de Regreso
const vueloRegreso = {
  aerolinea: document.getElementById("aerolineaRegreso")?.value || "",
  fecha: document.getElementById("fechaRegreso")?.value || "",
  vuelo: document.getElementById("vueloRegreso")?.value || "",
  codigo: document.getElementById("codigoBoletoRegreso")?.value || "",
  descripcion: document.getElementById("infoVueloRegreso")?.value || ""
};
  // Crear registro en costos_reservas
await db.collection("costos_reservas").doc(codigo).set({
  codigo: codigo,
  fecha_viaje: fechaReserva, // pod√©s cambiarlo luego si ten√©s una fecha espec√≠fica
  venta_total: total,
  estado: "Proyectado",
  creado_el: new Date(),
  actualizado_el: new Date()
});
    // Crear objeto a guardar
 const datos = {
  codigo,
  numero,
  a√±o,
  nombreTitular,
  cedula,
  correo,
  telefono,
  fechaNacimientoTitular,
  vencimientoPasaporteTitular,
  nacionalidadTitular,
  generoTitular,
  vueloIda,
  vueloRegreso,
  fechaReserva,
  destino,
  total,
  abono,
  saldo,
  pagos,
   embajadora,
  vuelosIntermedios: [],
  pasajeros: [],
   cantidadAdultos,
cantidadNinos,
cantidadBebes,
precioAdulto,
precioNino,
precioBebe,
  equipaje: document.getElementById("equipaje")?.value || "",
  toursOpcionales: Array.from(document.querySelectorAll("input[name='opcionales']:checked")).map(e => e.value)
   
   ,
duracion: document.getElementById("duracion")?.value || "",
itinerario: document.getElementById("itinerario")?.value || "",
hoteles: Array.from(document.querySelectorAll("#tablaHotelesBody tr")).map(tr => {
  const celdas = tr.querySelectorAll("td");
  return {
    nombre: celdas[0]?.innerText || "",
    checkin: celdas[1]?.innerText || "",
    checkout: celdas[2]?.innerText || "",
    tipo: celdas[3]?.innerText || "",
    cantidad: celdas[4]?.innerText || "",
    observaciones: celdas[5]?.innerText || ""
  };
})
};
console.log("Tours seleccionados:", datos.toursOpcionales);
    // Pasajeros
    document.querySelectorAll(".tarjeta-pasajero").forEach(p => {
      datos.pasajeros.push({
        nombre: p.querySelector(".nombrePasajero")?.value || "",
        documento: p.querySelector(".documentoPasajero")?.value || "",
        vencimiento: p.querySelector(".vencimientoPasaportePasajero")?.value || "",
        nacimiento: p.querySelector(".fechaNacimientoPasajero")?.value || "",
        nacionalidad: p.querySelector(".nacionalidadPasajero")?.value || "",
        genero: p.querySelector(".generoPasajero")?.value || ""
      });
    });


    // Vuelos intermedios
    document.querySelectorAll("#vuelosIntermediosContainer > div").forEach(vuelo => {
      datos.vuelosIntermedios.push({
        aerolinea: vuelo.querySelector("#aerolineaIda")?.value || "",
        fecha: vuelo.querySelector("#fechaIda")?.value || "",
        vuelo: vuelo.querySelector("#vueloIda")?.value || "",
        codigo: vuelo.querySelector("input[placeholder^='Ej. AUC']")?.value || "",
        descripcion: vuelo.nextElementSibling?.value || ""
      });
    });
// Validaci√≥n: Fecha de nacimiento del titular debe ser pasada
if (!fechaNacimientoTitular || new Date(fechaNacimientoTitular) > new Date()) {
  alert("‚ö†Ô∏è La fecha de nacimiento del titular debe ser v√°lida y estar en el pasado.");
  return;
}

// Validaci√≥n: Fecha de vencimiento del pasaporte debe ser futura
const vencimientoTitular = document.getElementById("vencimientoPasaporteTitular").value;
if (!vencimientoTitular || new Date(vencimientoTitular) < new Date()) {
  alert("‚ö†Ô∏è La fecha de vencimiento del pasaporte del titular debe ser futura.");
  return;
}

// Validaci√≥n: Pasajeros con fecha de nacimiento v√°lida
const tarjetasPasajero = document.querySelectorAll(".tarjeta-pasajero");
for (const tarjeta of tarjetasPasajero) {
  const nacimiento = tarjeta.querySelector(".fechaNacimientoPasajero");
  if (!nacimiento || new Date(nacimiento.value) > new Date()) {
    alert("‚ö†Ô∏è Todos los pasajeros deben tener una fecha de nacimiento v√°lida y en el pasado.");
    return;
  }
}
    console.log("Pagos enviados a Firebase:", datos.pagos);
    await db.collection("reservas").doc(codigo).set(datos);
    alert("‚úÖ Reserva guardada correctamente como " + codigo);
    document.getElementById("btnCostos").href = `costos_agregar.html?reserva=${codigo}`;
document.getElementById("btnCostos").style.display = "inline-block";
    document.getElementById("btnFacturar").href = `facturacion.html?reserva=${codigo}`;
document.getElementById("btnFacturar").style.display = "inline-block";
  } catch (e) {
    console.error("Error al guardar reserva:", e);
    alert("‚ùå Ocurri√≥ un error al guardar la reserva.");
  }
}

// Asociar al bot√≥n
document.getElementById("btnGuardarReserva").addEventListener("click", guardarReserva);
  
  function calcularTotalGeneral() {
    const cantidadAdultos = parseInt(document.getElementById("cantidadAdultos").value) || 0;
    const cantidadNinos = parseInt(document.getElementById("cantidadNinos").value) || 0;
    const cantidadBebes = parseInt(document.getElementById("cantidadBebes").value) || 0;

    const precioAdulto = parseFloat(document.getElementById("precioAdulto").value) || 0;
    const precioNino = parseFloat(document.getElementById("precioNino").value) || 0;
    const precioBebe = parseFloat(document.getElementById("precioBebe").value) || 0;
const embajadora = document.getElementById("embajadora").value || "";
    const total = (cantidadAdultos * precioAdulto) + (cantidadNinos * precioNino) + (cantidadBebes * precioBebe);
    document.getElementById("totalGeneral").value = total.toFixed(2);

    // Si hay listaPagos ya cargada, actualizamos el saldo tambi√©n:
    if (window.listaPagos) {
      const totalPagado = window.listaPagos.reduce((sum, p) => sum + p.monto, 0);
      const saldo = total - totalPagado;
      document.getElementById("saldoPendiente").textContent = saldo.toFixed(2);

      
    }
  }
  // Cargar cotizaci√≥n
  function cargarDesdeCotizacion() {
    const codigo = document.getElementById('codigoCotizacion').value.trim();
    const contenedor = document.getElementById("infoCotizacion");
    if (!codigo) return alert("Por favor ingresa un c√≥digo de cotizaci√≥n.");
    contenedor.innerHTML = "Cargando informaci√≥n...";
    db.collection("cotizaciones").doc(codigo).get().then(doc => {
      if (doc.exists) {
        const data = doc.data();
        contenedor.innerHTML = `
          <h3>Resumen</h3>
          <p><strong>Destino:</strong> ${data.destino || 'No disponible'}</p>
          <p><strong>Aerol√≠nea:</strong> ${data.aerolinea || 'No disponible'}</p>
          <p><strong>Hotel:</strong> ${data.hotel || 'No disponible'}</p>
          <p><strong>Incluye:</strong> ${data.incluye || 'No disponible'}</p>
        `;
      } else {
        contenedor.innerHTML = `<p style="color:red;">No se encontr√≥ una cotizaci√≥n con ese c√≥digo.</p>`;
      }
    }).catch(err => {
      console.error(err);
      contenedor.innerHTML = `<p style="color:red;">Error al cargar datos.</p>`;
    });
  }

  // Agregar vuelo intermedio
  let vueloCounter = 1;
  function agregarVueloIntermedio() {
    const container = document.getElementById("vuelosIntermediosContainer");
    const html = `
     <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap; margin-bottom: 10px;">
  
  <!-- Aerol√≠nea -->
  <div style="display: flex; align-items: center; gap: 6px;">
    <label for="aerolineaIda">Aerol√≠nea:</label>
    <select id="aerolineaIda" style="min-width: 160px;">
      <option value="">Seleccione una</option>
      <option value="Avianca">Avianca</option>
      <option value="Volaris">Volaris</option>
      <option value="Copa Airlines">Copa Airlines</option>
      <option value="Wingo">Wingo</option>
    </select>
  </div>

  <!-- Fecha -->
  <div style="display: flex; align-items: center; gap: 6px;">
    <label for="fechaIda">Fecha:</label>
    <input type="date" id="fechaIda" style="min-width: 140px;">
  </div>

  <!-- N¬∞ de Vuelo -->
  <div style="display: flex; align-items: center; gap: 6px;">
    <label for="vueloIda" style="white-space: nowrap;">N¬∞ de Vuelo:</label>
    <input type="text" id="vueloIda" placeholder="Ej. AV637" style="min-width: 130px;">
  </div>
  <div style="display: flex; align-items: center; gap: 6px;">
  <label style="white-space: nowrap;">C√≥digo de Aerol√≠nea:</label>
  <input type="text" placeholder="Ej. AUC5TG" style="min-width: 160px;">
</div>

 </div>
      <label style="display:block; margin-top: 10px;">Informaci√≥n del Vuelo</label>
      <textarea placeholder="Ej. Cartagena ‚Üí Bogot√°, escala de 2h" rows="2" style="width: 100%;"></textarea>
    </section>
    
  `;
    container.insertAdjacentHTML("beforeend", html);
    vueloCounter++;
  }

function agregarPasajero() {
  const container = document.getElementById("pasajerosContainer");

  const pasajeroDiv = document.createElement("div");
  pasajeroDiv.classList.add("tarjeta-pasajero");
  pasajeroDiv.style = `
    border: 1px solid #ccc;
    padding: 20px;
    margin-bottom: 20px;
    border-radius: 12px;
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    position: relative;
  `;

  pasajeroDiv.innerHTML = `
    <span onclick="this.parentElement.remove()" 
          style="position:absolute; top:10px; right:10px; cursor:pointer; color:#b00020; font-weight:bold;">‚ùå</span>

    <h4 style="color:#02535a; margin-bottom: 15px;">Pasajero</h4>

    <!-- Fila 1 -->
    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
      <div style="flex: 1; min-width: 250px;">
        <label>Nombre Completo</label>
        <input type="text" class="nombrePasajero" placeholder="Ej. Juan P√©rez" style="width: 100%;">
      </div>

      <div style="flex: 1; min-width: 250px;">
        <label>C√©dula o Pasaporte</label>
        <input type="text" class="documentoPasajero" placeholder="Ej. 123456789" style="width: 100%;">
      </div>
    </div>

    <!-- Fila 2 -->
   <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-top: 15px;">
    <div style="flex: 1; min-width: 250px;">
      <label>Fecha de Vencimiento del Pasaporte</label>
        <input type="date" class="vencimientoPasaportePasajero" style="width: 100%;">
    </div>

<div style="flex: 1; min-width: 250px;">
  <label for="fechaNacimientoTitular">Fecha de Nacimiento</label>
   <div style="display: flex; align-items: center; gap: 10px;">
          <input type="date" class="fechaNacimientoPasajero" onchange="calcularEdadPasajero(this)" style="width: 100%;">
          <span class="edadPasajero" style="font-weight: bold; white-space: nowrap;">Edad: -</span>
        </div>
          </div>
</div>
    <!-- Fila 3 -->
    <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-top: 12px;">
      <div style="flex: 1; min-width: 200px;">
        <label>Nacionalidad</label>
        <input type="text" class="nacionalidadPasajero" placeholder="Ej. Costarricense" style="width: 100%;">
      </div>

      <div style="flex: 1; min-width: 200px;">
        <label>G√©nero</label>
        <select class="generoPasajero" style="width: 100%;">
          <option value="">Seleccione</option>
          <option value="Femenino">Femenino</option>
          <option value="Masculino">Masculino</option>
        </select>
      </div>
    </div>
  `;

  container.appendChild(pasajeroDiv);
}

function calcularEdadPasajero(inputFecha) {
  const fecha = new Date(inputFecha.value);
  const hoy = new Date();

  // Validaci√≥n: no permitir fechas futuras
  if (fecha > hoy) {
    alert("‚ö†Ô∏è La fecha de nacimiento no puede ser futura.");
    inputFecha.value = "";
    const edadSpan = inputFecha.parentElement.querySelector('.edadPasajero');
    if (edadSpan) edadSpan.textContent = "Edad: -";
    return;
  }

  // C√°lculo de edad
  let edad = hoy.getFullYear() - fecha.getFullYear();
  const mes = hoy.getMonth() - fecha.getMonth();
  if (mes < 0 || (mes === 0 && hoy.getDate() < fecha.getDate())) {
    edad--;
  }

  // Mostrar edad
  const edadSpan = inputFecha.parentElement.querySelector('.edadPasajero');
  if (edadSpan) {
    edadSpan.textContent = isNaN(edad) ? "Edad: -" : `Edad: ${edad} a√±os`;
  }

  return edad;
}

// Titular
document.getElementById("fechaNacimientoTitular").addEventListener("change", function () {
  const fecha = this.value;
  const edad = calcularEdadGeneral(fecha);
  document.getElementById("edadTitular").textContent = isNaN(edad) ? "Edad: -" : `Edad: ${edad} a√±os`;

  // Validaci√≥n: fecha no puede ser futura
  if (new Date(fecha) > new Date()) {
    alert("‚ö†Ô∏è La fecha de nacimiento del titular no puede ser futura.");
    this.value = "";
    document.getElementById("edadTitular").textContent = "Edad: -";
  }
});

// Funci√≥n base para otros usos si se necesita
function calcularEdadGeneral(fechaNacimiento) {
  const hoy = new Date();
  const nacimiento = new Date(fechaNacimiento);
  let edad = hoy.getFullYear() - nacimiento.getFullYear();
  const mes = hoy.getMonth() - nacimiento.getMonth();
  if (mes < 0 || (mes === 0 && hoy.getDate() < nacimiento.getDate())) {
    edad--;
  }
  return edad;
}
function mostrarEdadTitular() {
  const fecha = document.getElementById("fechaNacimientoTitular").value;
  const edad = calcularEdadGeneral(fecha);  // ‚Üê nombre corregido
  document.getElementById("edadTitular").textContent = `Edad: ${edad} a√±os`;
}
 function agregarEquipaje() {
  const tipo = document.getElementById("tipo_equipaje").value;
  const cantidad = document.getElementById("cantidad_equipaje").value;
  const uso = document.getElementById("uso_equipaje").value;
  const textarea = document.getElementById("equipaje");

  if (!tipo || !cantidad || !uso) {
    alert("Por favor completa los tres campos antes de agregar el equipaje.");
    return;
  }

  const linea = `${cantidad} ${tipo.toLowerCase()}(s) ${uso}`;
  textarea.value += (textarea.value ? '\n' : '') + linea;

  // Limpiar campos
  document.getElementById("tipo_equipaje").value = "";
  document.getElementById("cantidad_equipaje").value = "";
  document.getElementById("uso_equipaje").value = "";
}
async function cargarDestinos() {
  try {
    const ref = db.collection("tours");
    const snapshot = await ref.get();
    const select = document.getElementById("destino");

    snapshot.forEach(doc => {
      const data = doc.data();
      const opt = document.createElement("option");
      opt.value = doc.id;
      opt.textContent = data.nombre || doc.id;
      select.appendChild(opt);
    });
  } catch (e) {
    console.error("Error al cargar destinos:", e);
  }

  async function cargarInfoTour(destinoId) {
    if (!destinoId) return;

    try {
      const doc = await db.collection("tours").doc(destinoId).get();
      if (doc.exists) {
        const data = doc.data();
        document.getElementById("duracion").value = data.duracion || "";
        document.getElementById("itinerario").value = data.itinerario_tours || "";
        window.hotelesDelDestino = data.hoteles || [];

        const lista = document.getElementById("toursOpcionalesLista");
        lista.innerHTML = "";

        if (Array.isArray(data.tours_opcionales)) {
          data.tours_opcionales.forEach(item => {
            const card = document.createElement("div");
            card.style = `
              border: 1px solid #ccc;
              padding: 10px 15px;
              border-radius: 8px;
              background: #f9f9f9;
              display: flex;
              align-items: center;
              gap: 10px;
              min-width: 250px;
            `;
            card.innerHTML = `
              <input type="checkbox" name="opcionales" value="${item.nombre}">
              <span><strong>${item.nombre}</strong> - $${item.precio}</span>
            `;
            lista.appendChild(card);
          });
        }
      }
    } catch (e) {
      console.error("Error al cargar informaci√≥n del tour:", e);
    }
  }

  // ‚úÖ Exponer despu√©s de la funci√≥n
  window.cargarInfoTour = cargarInfoTour;

} // ‚úÖ ESTE es el que faltaba
  
  function autoResizeTextarea(textarea) {
    textarea.style.height = 'auto'; // reset
    textarea.style.height = (textarea.scrollHeight + 2) + 'px'; // ajuste real
  }
function abrirModalHotel() {
  const destinoSeleccionado = document.getElementById("destino").value;
  const selectHotel = document.getElementById("modal_nombre_hotel");

  if (!destinoSeleccionado) {
    alert("Por favor selecciona un destino antes de agregar un hotel.");
    return;
  }

  selectHotel.innerHTML = "<option value=''>Cargando hoteles...</option>";

  db.collection("tours").doc(destinoSeleccionado).get().then(doc => {
    if (doc.exists) {
      const data = doc.data();
      selectHotel.innerHTML = "<option value=''>Seleccione un hotel</option>";

      if (Array.isArray(data.hoteles)) {
        data.hoteles.forEach(hotel => {
          const opt = document.createElement("option");
          opt.value = hotel.nombre || hotel;
          opt.textContent = hotel.nombre || hotel;
          selectHotel.appendChild(opt);
        });
      }
    } else {
      selectHotel.innerHTML = "<option value=''>No se encontraron hoteles</option>";
    }
  });

  document.getElementById("modalHotel").style.display = "flex";
}
function cerrarModalHotel() {
  document.getElementById("modalHotel").style.display = "none";
}

function guardarHotelModal() {
  const hotel = document.getElementById("modal_nombre_hotel").value;
    if (!hotel) {
  alert("Debes seleccionar un hotel.");
  return;
}
  
  const checkIn = document.getElementById("modal_checkin").value;
  const checkOut = document.getElementById("modal_checkout").value;
  const tipo = document.getElementById("modal_tipoHabitacion_hotel").value;
  const cantidad = document.getElementById("modal_cantidadHabitacion_hotel").value;
  const obs = document.getElementById("modal_observaciones_hotel").value;

  const tbody = document.getElementById("tablaHotelesBody");
  const row = document.createElement("tr");

  row.innerHTML = `
    <td>${hotel}</td>
    <td>${checkIn}</td>
    <td>${checkOut}</td>
    <td>${tipo}</td>
    <td>${cantidad}</td>
    <td>${obs || 'Sin observaciones'}</td>
  `;

  tbody.appendChild(row);
  cerrarModalHotel();
}// üëá Asegurate de mantener la global como est√°:
window.listaPagos = window.listaPagos || [];

function calcularTotal() {
  const adultos = parseInt(document.getElementById("cantidadAdultos").value) || 0;
  const ninos = parseInt(document.getElementById("cantidadNinos").value) || 0;
  const bebes = parseInt(document.getElementById("cantidadBebes").value) || 0;

  const precioAdulto = parseFloat(document.getElementById("precioAdulto").value) || 0;
  const precioNino = parseFloat(document.getElementById("precioNino").value) || 0;
  const precioBebe = parseFloat(document.getElementById("precioBebe").value) || 0;

  const total = (adultos * precioAdulto) + (ninos * precioNino) + (bebes * precioBebe);
  document.getElementById("totalGeneral").value = total.toFixed(2);

  actualizarResumenPagos();
}
function agregarPago() {
  const fecha = document.getElementById("fechaPago").value;
  const monto = parseFloat(document.getElementById("montoPago").value);
  const tipo = document.getElementById("tipoPago").value;

  if (!fecha || isNaN(monto) || monto <= 0 || !tipo) {
    alert("Por favor complet√° todos los campos del pago.");
    return;
  }

  // Agregar a la lista global
  window.listaPagos.push({ fecha, tipo, monto });

  // Actualizar tabla
  const fila = document.createElement("tr");
  fila.innerHTML = `
    <td>${fecha}</td>
    <td>${tipo}</td>
    <td>$${monto.toFixed(2)}</td>
  `;
  document.getElementById("tablaPagos").appendChild(fila);

  // ‚úÖ Aqu√≠ estaba el error:
  console.log("Pagos guardados:", window.listaPagos);

  // Actualizar totales
  actualizarTotales();

  // Limpiar campos
  document.getElementById("fechaPago").value = "";
  document.getElementById("montoPago").value = "";
  document.getElementById("tipoPago").value = "";
}

 function actualizarTotales() {
  const totalPagado = window.listaPagos?.reduce((sum, p) => sum + parseFloat(p.monto || 0), 0);
  const totalGeneral = parseFloat(document.getElementById("totalGeneral").value) || 0;
  const saldoPendiente = totalGeneral - totalPagado;

  document.getElementById("totalPagado").textContent = totalPagado.toFixed(2);
  document.getElementById("saldoPendiente").textContent = saldoPendiente.toFixed(2);

  // Si ten√©s un input oculto con id="montoAbono", actualizalo tambi√©n:
  document.getElementById("montoAbono").value = totalPagado.toFixed(2);
}
  function verificarFilasHabitaciones() {
  const tabla = document.getElementById("tablaResumenHabitaciones");
  const tieneFilas = tabla.querySelector("tbody").children.length > 0;
  tabla.style.display = tieneFilas ? "table" : "none";
}
  
  // Aplicar a todos los que tengan la clase autoresize
    document.querySelectorAll('.autoresize').forEach(textarea => {
      textarea.addEventListener('input', () => autoResizeTextarea(textarea));
      autoResizeTextarea(textarea); // inicial
    });
  // Ejecutar al cargar la p√°gina
document.addEventListener("DOMContentLoaded", async () => {
  await cargarDestinos(); // üëà importante el await
   window.listaPagos = window.listaPagos || []; // ‚úÖ BONUS aqu√≠
  document.getElementById("btnAgregarVuelo").addEventListener("click", agregarVueloIntermedio);
  window.abrirModalHotel = abrirModalHotel;
  window.cerrarModalHotel = cerrarModalHotel;
  window.guardarHotelModal = guardarHotelModal;

  // üîç Detectar si hay un c√≥digo en la URL
  const params = new URLSearchParams(window.location.search);
const codigo = params.get("codigo") || params.get("id"); // acepta ambos

 if (codigo) {
  await cargarReservaExistente(codigo); // ‚úÖ usa directamente la variable que s√≠ est√° definida

   // ‚úÖ Mostrar el bot√≥n solo si se carg√≥ correctamente la reserva
    document.getElementById("btnCostos").href = `costos_agregar.html?reserva=${codigo}`;
    document.getElementById("btnCostos").style.display = "inline-block";
   document.getElementById("btnFacturar").href = `facturacion.html?reserva=${codigo}`;
document.getElementById("btnFacturar").style.display = "inline-block";
}
});
 async function cargarReservaExistente(codigo) {
  try {
    const doc = await db.collection("reservas").doc(codigo).get();
    if (!doc.exists) {
      alert("‚ùå No se encontr√≥ la reserva.");
      return;
    }

    const data = doc.data();

    // Campos principales
    document.getElementById("nombreTitular").value = data.nombreTitular || "";
    document.getElementById("cedulaTitular").value = data.cedula || "";
    document.getElementById("correoTitular").value = data.correo || "";
    document.getElementById("telefonoTitular").value = data.telefono || "";
    document.getElementById("equipaje").value = data.equipaje || "";
    document.getElementById("destino").value = data.destino || "";
    document.getElementById("totalGeneral").value = data.total?.toFixed(2) || "0.00";
 // ‚úÖ Vuelo de Ida
if (data.vueloIda) {
  document.getElementById("aerolineaIda").value = data.vueloIda.aerolinea || "";
  document.getElementById("fechaIda").value = data.vueloIda.fecha || "";
  document.getElementById("vueloIda").value = data.vueloIda.vuelo || "";
  document.getElementById("codigoBoletoIda").value = data.vueloIda.codigo || "";
  document.getElementById("infoVueloIda").value = data.vueloIda.descripcion || "";
}

    // ‚úÖ Vuelo de Regreso
if (data.vueloRegreso) {
  document.getElementById("aerolineaRegreso").value = data.vueloRegreso.aerolinea || "";
  document.getElementById("fechaRegreso").value = data.vueloRegreso.fecha || "";
  document.getElementById("vueloRegreso").value = data.vueloRegreso.vuelo || "";
  document.getElementById("codigoBoletoRegreso").value = data.vueloRegreso.codigo || "";
  document.getElementById("infoVueloRegreso").value = data.vueloRegreso.descripcion || "";
}
document.getElementById("fechaNacimientoTitular").value = data.fechaNacimientoTitular || "";
    if (data.fechaNacimientoTitular) {
  mostrarEdadTitular(); // ‚¨ÖÔ∏è Esto usa la funci√≥n que ya ten√©s
}
document.getElementById("vencimientoPasaporteTitular").value = data.vencimientoPasaporteTitular || "";
document.getElementById("nacionalidadTitular").value = data.nacionalidadTitular || "";
document.getElementById("generoTitular").value = data.generoTitular || "";
    
    document.getElementById("destino").value = data.destino || "";
console.log("Tours seleccionados:", data.toursOpcionales);

    // üéØ Mostrar desglose de inversi√≥n
document.getElementById("cantidadAdultos").value = data.cantidadAdultos || 0;
document.getElementById("cantidadNinos").value = data.cantidadNinos || 0;
document.getElementById("cantidadBebes").value = data.cantidadBebes || 0;

document.getElementById("precioAdulto").value = data.precioAdulto || 0;
document.getElementById("precioNino").value = data.precioNino || 0;
document.getElementById("precioBebe").value = data.precioBebe || 0;

document.getElementById("embajadora").value = data.embajadora || "";
    
await cargarInfoTour(data.destino); // üîÑ Cargar visualmente las tarjetas
console.log("Tours seleccionados:", data.toursOpcionales); // ‚úÖ Mostrar los que se cargaron

// Luego marcar los checkboxes
if (Array.isArray(data.toursOpcionales)) {
  data.toursOpcionales.forEach(nombre => {
    const checkbox = document.querySelector(`input[name="opcionales"][value="${nombre}"]`);
    if (checkbox) checkbox.checked = true;
  });
}
// Cargar pagos desde la colecci√≥n de facturas
const pagosSnapshot = await db.collection("facturas").where("reserva", "==", codigo).get();
window.listaPagos = [];

const tabla = document.getElementById("tablaPagos");
const historial = document.getElementById("tablaHistorialPagos");
tabla.innerHTML = "";
historial.innerHTML = "";

let totalPagado = 0;

if (!pagosSnapshot.empty) {
  pagosSnapshot.forEach(doc => {
    const pago = doc.data();
    const fecha = pago.fecha || "";
    const metodo = pago.metodo || "";
    const monto = parseFloat(pago.monto || 0);
    const nota = pago.nota || "";

    // Guardar en lista
    window.listaPagos.push({ fecha, tipo: metodo, monto, nota });

    // Mostrar en tabla simple
    const fila = document.createElement("tr");
    fila.innerHTML = `
      <td>${fecha}</td>
      <td>${metodo}</td>
      <td>$${monto.toFixed(2)}</td>
    `;
    tabla.appendChild(fila);

    // Mostrar en historial
    const filaHist = document.createElement("tr");
    filaHist.innerHTML = `
      <td style="padding: 8px;">${fecha}</td>
      <td style="padding: 8px;">${metodo}</td>
      <td style="padding: 8px;">$${monto.toFixed(2)}</td>
      <td style="padding: 8px;">${nota || "‚Äî"}</td>
    `;
    historial.appendChild(filaHist);

    totalPagado += monto;
  });
} else {
  historial.innerHTML = `<tr><td colspan="4" style="text-align:center; color: #888;">No hay pagos registrados</td></tr>`;
  document.getElementById("btnFacturar").style.display = "none";
}

// Mostrar totales
document.getElementById("totalPagado").textContent = totalPagado.toFixed(2);
const totalGeneral = parseFloat(document.getElementById("totalGeneral").value) || 0;
const saldoPendiente = totalGeneral - totalPagado;
document.getElementById("saldoPendiente").textContent = saldoPendiente.toFixed(2);
    
     // ‚úÖ Pasajeros
    if (Array.isArray(data.pasajeros)) {
      data.pasajeros.forEach(p => {
        agregarPasajero();
        const cont = document.querySelectorAll(".tarjeta-pasajero");
        const ult = cont[cont.length - 1];
      if (ult) {
  const nombre = ult.querySelector(".nombrePasajero");
  if (nombre) nombre.value = p.nombre || "";

  const documento = ult.querySelector(".documentoPasajero");
  if (documento) documento.value = p.documento || "";

  const vencimiento = ult.querySelector(".vencimientoPasaportePasajero");
  if (vencimiento) vencimiento.value = p.vencimiento || "";

  const nacimiento = ult.querySelector(".fechaNacimientoPasajero");
if (nacimiento) {
  nacimiento.value = p.nacimiento || "";
  calcularEdadPasajero(nacimiento); // <- Esta es la nueva l√≠nea
}
  const nacionalidad = ult.querySelector(".nacionalidadPasajero");
  if (nacionalidad) nacionalidad.value = p.nacionalidad || "";

  const genero = ult.querySelector(".generoPasajero");
  if (genero) genero.value = p.genero || "";
}
      });
    }
    // ‚úÖ Duraci√≥n e itinerario del tour
if (data.duracion) {
  const duracionInput = document.getElementById("duracion");
  if (duracionInput) duracionInput.value = data.duracion || "";
}

if (data.itinerario) {
  const itinerarioInput = document.getElementById("itinerario");
  if (itinerarioInput) itinerarioInput.value = data.itinerario || "";
}

// ‚úÖ Hoteles seleccionados
if (Array.isArray(data.hoteles)) {
  const tbody = document.getElementById("tablaHotelesBody");
  if (tbody) {
    tbody.innerHTML = ""; // limpia si ya hay algo cargado
    data.hoteles.forEach(h => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${h.nombre || ""}</td>
        <td>${h.checkin || ""}</td>
        <td>${h.checkout || ""}</td>
        <td>${h.tipo || ""}</td>
        <td>${h.cantidad || ""}</td>
        <td>${h.observaciones || "Sin observaciones"}</td>
      `;
      tbody.appendChild(row);
    });
  }
}
    // ‚úÖ Vuelos intermedios
    if (Array.isArray(data.vuelosIntermedios)) {
      data.vuelosIntermedios.forEach(v => {
        agregarVueloIntermedio();
        const vuelos = document.querySelectorAll("#vuelosIntermediosContainer > div");
        const ult = vuelos[vuelos.length - 1];
      if (ult) {
  const campoAerolinea = ult.querySelector("#aerolineaIda");
  if (campoAerolinea) campoAerolinea.value = v.aerolinea || "";

  const campoFecha = ult.querySelector("#fechaIda");
  if (campoFecha) campoFecha.value = v.fecha || "";

  const campoVuelo = ult.querySelector("#vueloIda");
  if (campoVuelo) campoVuelo.value = v.vuelo || "";

  const campoCodigo = ult.querySelector("input[placeholder^='Ej. AUC']");
  if (campoCodigo) campoCodigo.value = v.codigo || "";

  const textarea = ult.nextElementSibling;
  if (textarea && textarea.tagName === "TEXTAREA") textarea.value = v.descripcion || "";
}
      });
    }
console.log("Total cargado:", document.getElementById("totalGeneral").value);
console.log("Pagos:", window.listaPagos);

     actualizarTotales(); // üëâ Actualiza total pagado y saldo correctamente
  } catch (e) {
    console.error("‚ùå Error al cargar reserva:", e);
    alert("Error al cargar la reserva.");
  }
function generarFactura() {
  alert("üìÑ Funci√≥n de facturaci√≥n en construcci√≥n.");
}

function cargarHistorialPagos() {
  const contenedor = document.getElementById("tablaHistorialPagos");
  if (!contenedor) {
    console.warn("‚ö†Ô∏è tablaHistorialPagos no est√° disponible en el DOM.");
    return;
  }

  contenedor.innerHTML = "";
  const pagos = window.listaPagos || [];

  if (pagos.length === 0) {
    contenedor.innerHTML = `<tr><td colspan="4" style="text-align:center; color: #888;">No hay pagos registrados</td></tr>`;
    document.getElementById("btnFacturar").style.display = "none";
    return;
  }

  pagos.forEach(p => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td style="padding: 8px;">${p.fecha}</td>
      <td style="padding: 8px;">${p.tipo}</td>
      <td style="padding: 8px;">$${parseFloat(p.monto).toFixed(2)}</td>
      <td style="padding: 8px;">${p.nota || "‚Äî"}</td>
    `;
    contenedor.appendChild(tr);
  });

  document.getElementById("btnFacturar").style.display = "inline-block";
}

</script>

</body>
</html>
