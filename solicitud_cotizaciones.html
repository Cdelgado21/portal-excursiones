<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Solicitudes de Cotizaci√≥n</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f0f7f7; padding: 20px; }
    h2 { text-align: center; color: #02535a; }
    form { background: white; padding: 20px; border-radius: 10px; max-width: 600px; margin: 20px auto; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    label { display: block; margin-top: 15px; color: #02535a; }
    input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; }
    button { margin-top: 20px; padding: 10px 20px; background-color: #02535a; color: white; border: none; border-radius: 5px; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 40px; background: white; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: left; }
    th { background-color: #02535a; color: white; }
    .estado-pendiente { background-color: #ff4d4d; color: white; padding: 5px 8px; border-radius: 5px; font-weight: bold; text-align: center; }
    .estado-proceso { background-color: #ffa500; color: white; padding: 5px 8px; border-radius: 5px; font-weight: bold; text-align: center; }
    .container { max-width: 1000px; margin: auto; }
    .btn-cotizar { background-color: #f49859; color: white; padding: 5px 10px; border: none; border-radius: 5px; cursor: pointer; }
    .btn-cotizar[disabled] { background-color: #ccc; cursor: not-allowed; }
    .acciones-superiores { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .logo { height: 50px; }
    .modulos { display: flex; gap: 10px; }
    .modulos button { background-color: #02535a; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; }
    #modal { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
    #modal-content { background: white; padding: 20px; border-radius: 10px; max-width: 400px; width: 100%; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
    #modal-content h3 { color: #02535a; margin-bottom: 15px; }
    #modal-content select, #modal-content button { margin-top: 10px; width: 100%; }
  </style>
</head>
<body>
  <div class="container">
    <div class="acciones-superiores">
      <img src="https://i.imgur.com/qK3pLWi.png" alt="Logo" class="logo" onclick="location.href='menu.html'" style="cursor:pointer;">
      <div class="modulos">
        <button onclick="location.href='tours.html'">Tours</button>
        <button onclick="location.href='cotizaciones.html'">Cotizaciones</button>
        <button onclick="location.href='reservas.html'">Reservas</button>
        <button onclick="location.href='clientes.html'">Clientes</button>
      </div>
    </div>

    <h2>Solicitudes de Cotizaci√≥n</h2>

    <form id="formularioSolicitud">
      <label for="telefono">N√∫mero de tel√©fono:</label>
      <input type="text" id="telefono" required>

      <label for="destino">Destino:</label>
      <select id="destino" required></select>

      <label for="fechas">Rango de fechas del viaje:</label>
      <input type="text" id="fechas" required>

      <label for="adultos">Cantidad de adultos:</label>
      <input type="number" id="adultos" required min="1">

      <label for="ninos">Cantidad de ni√±os:</label>
      <input type="number" id="ninos" required min="0">

      <label for="observaciones">Observaciones:</label>
      <textarea id="observaciones"></textarea>

      <label for="embajador">Embajador(a) a cargo:</label>
      <select id="embajador" required>
        <option value="">Seleccione</option>
        <option value="Cristopher">Cristopher</option>
        <option value="Marcela">Marcela</option>
        <option value="Tatiana">Tatiana</option>
        <option value="Yare">Yare</option>
        <option value="Yuliana">Yuliana</option>
        <option value="Geansury">Geansury</option>
      </select>

      <button type="submit">Enviar solicitud</button>
    </form>

    <div class="acciones-superiores" style="margin-top: 30px; justify-content: flex-end;">
      <button onclick="imprimirTabla()">üñ®Ô∏è</button>
      <button onclick="descargarPDF()">üìÑ</button>
      <button onclick="descargarExcel()">üì•</button>
    </div>

    <table id="tablaSolicitudes">
      <thead>
        <tr>
          <th>N√∫mero</th>
          <th>Tel√©fono</th>
          <th>Destino</th>
          <th>Fechas</th>
          <th>Adultos</th>
          <th>Ni√±os</th>
          <th>Observaciones</th>
          <th>Embajador(a)</th>
          <th>Estado</th>
          <th>Registro</th>
          <th>Tiempo en espera</th>
          <th>Encargado</th>
          <th>Fecha Asignaci√≥n</th>
          <th>Acci√≥n</th>
          <th>Editar</th>
          <th>Eliminar</th>
        </tr>
      </thead>
      <tbody id="cuerpoTabla">
        <!-- Se insertan filas autom√°ticamente -->
      </tbody>
    </table>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDUEZgkW-3HbZu2BLej4v0mbDHZf2vRo8",
      authDomain: "tours-460717.firebaseapp.com",
      projectId: "tours-460717"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    function cargarDestinos() {
      const selectDestino = document.getElementById("destino");
      db.collection("tours").get().then((querySnapshot) => {
        selectDestino.innerHTML = '<option value="">Seleccione un destino</option>';
        querySnapshot.forEach((doc) => {
          const nombre = doc.data().nombre;
          if (nombre) {
            const option = document.createElement("option");
            option.value = nombre;
            option.textContent = nombre;
            selectDestino.appendChild(option);
          }
        });
      });
    }

    document.getElementById("formularioSolicitud").addEventListener("submit", async (e) => {
      e.preventDefault();
      const telefono = document.getElementById("telefono").value;
      const destino = document.getElementById("destino").value;
      const fechas = document.getElementById("fechas").value;
      const adultos = parseInt(document.getElementById("adultos").value);
      const ninos = parseInt(document.getElementById("ninos").value);
      const observaciones = document.getElementById("observaciones").value;
      const embajador = document.getElementById("embajador").value;

      if (!telefono || !destino || !fechas || isNaN(adultos) || isNaN(ninos) || !embajador) {
        alert("Por favor complete todos los campos obligatorios.");
        return;
      }

      const numero = `COT-${Date.now()}`;
      const timestamp = new Date();
      const nuevaSolicitud = {
        numero,
        telefono,
        destino,
        fechas,
        adultos,
        ninos,
        observaciones,
        embajador,
        estado: "Pendiente",
        registro: firebase.firestore.Timestamp.fromDate(timestamp),
        encargado: "-",
        fecha_asignacion: null
      };

      try {
        await db.collection("solicitudes").add(nuevaSolicitud);
        alert("‚úÖ ¬°Solicitud registrada exitosamente!");
        document.getElementById("formularioSolicitud").reset();
        cargarSolicitudes();
      } catch (error) {
        console.error("Error al guardar:", error);
        alert("‚ùå Error al guardar la solicitud. Intente nuevamente.");
      }
    });

    function cargarSolicitudes() {
      db.collection("solicitudes").orderBy("registro", "desc").get().then(snapshot => {
        const tbody = document.getElementById("cuerpoTabla");
        tbody.innerHTML = "";
        snapshot.forEach(doc => {
          const data = doc.data();
          const row = document.createElement("tr");
          const tiempoEnMinutos = Math.floor((Date.now() - data.registro.toDate()) / 60000);
          row.innerHTML = `
            <td>${data.numero}</td>
            <td>${data.telefono}</td>
            <td>${data.destino}</td>
            <td>${data.fechas}</td>
            <td>${data.adultos}</td>
            <td>${data.ninos}</td>
            <td>${data.observaciones || "-"}</td>
            <td>${data.embajador}</td>
            <td><span class="${data.estado === 'Pendiente' ? 'estado-pendiente' : 'estado-proceso'}">${data.estado}</span></td>
            <td>${data.registro.toDate().toLocaleString()}</td>
            <td>${data.estado === "Pendiente" ? tiempoEnMinutos + " min" : "-"}</td>
            <td>${data.encargado || "-"}</td>
            <td>${data.fecha_asignacion ? data.fecha_asignacion.toDate().toLocaleString() : "-"}</td>
            <td><button class="btn-cotizar">Tomar</button></td>
            <td><button>‚úèÔ∏è</button></td>
            <td><button>üóëÔ∏è</button></td>
          `;
          tbody.appendChild(row);
        });
      });
    }

    function imprimirTabla() {
      const tabla = document.getElementById("tablaSolicitudes");
      const win = window.open("", "_blank");
      win.document.write('<html><head><title>Imprimir Tabla</title></head><body>');
      win.document.write(tabla.outerHTML);
      win.document.write('</body></html>');
      win.document.close();
      win.print();
    }

    function descargarPDF() {
      html2canvas(document.querySelector("#tablaSolicitudes")).then(canvas => {
        const imgData = canvas.toDataURL("image/png");
        const pdf = new jspdf.jsPDF();
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth() - 20;
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        pdf.addImage(imgData, "PNG", 10, 10, pdfWidth, pdfHeight);
        pdf.save("solicitudes.pdf");
      });
    }

    function descargarExcel() {
      const tabla = document.getElementById("tablaSolicitudes");
      const filas = tabla.querySelectorAll("tr");
      const csv = Array.from(filas).map(row =>
        Array.from(row.cells).map(cell => cell.innerText).join(",")
      ).join("\n");
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "solicitudes.csv";
      a.click();
    }

    window.onload = () => {
      cargarDestinos();
      cargarSolicitudes();
    };
  </script>
</body>
</html>

