<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Solicitud de Cotizaciones</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f7f7;
      margin: 0;
      padding: 20px;
    }
    h2 {
      text-align: center;
      color: #02535a;
    }
    .formulario, .tabla-container {
      max-width: 1200px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    input, select {
      width: 100%;
      padding: 10px;
      margin-bottom: 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button {
      background-color: #02535a;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    button.btn-cotizar {
      background-color: #f49859;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
      vertical-align: middle;
    }
    th {
      background-color: #02535a;
      color: white;
    }
    .estado-pendiente {
      background: #dc3545;
      color: white;
      font-weight: bold;
      padding: 4px 8px;
      border-radius: 5px;
    }
    .estado-proceso {
      background: #ffc107;
      color: black;
      font-weight: bold;
      padding: 4px 8px;
      border-radius: 5px;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 999;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      width: 300px;
      text-align: center;
    }
    .modal-content select {
      margin: 10px 0;
    }
  </style>
</head>
<body>

  <h2>Solicitud de Cotizaciones</h2>

  <div class="formulario">
    <form id="formularioSolicitud">
      <input type="text" id="telefono" placeholder="Tel√©fono del cliente" required />
      <input type="text" id="destino" placeholder="Destino" required />
      <input type="text" id="fechas" placeholder="Rango de fechas del viaje" required />
      <input type="number" id="adultos" placeholder="Cantidad de adultos" required />
      <input type="number" id="ninos" placeholder="Cantidad de ni√±os" />
      <input type="text" id="observaciones" placeholder="Observaciones" />
      <select id="embajador" required>
        <option value="">Embajador(a) a cargo</option>
        <option value="Cristopher">Cristopher</option>
        <option value="Marcela">Marcela</option>
        <option value="Yare">Yare</option>
        <option value="Yuliana">Yuliana</option>
        <option value="Tatiana">Tatiana</option>
        <option value="Geansury">Geansury</option>
      </select>
      <button type="submit">Enviar solicitud</button>
    </form>
  </div>

  <div class="tabla-container">
    <table>
      <thead>
        <tr>
          <th>N√∫mero</th>
          <th>Tel√©fono</th>
          <th>Destino</th>
          <th>Fechas</th>
          <th>Adultos</th>
          <th>Ni√±os</th>
          <th>Observaciones</th>
          <th>Embajador(a)</th>
          <th>Estado</th>
          <th>Registro</th>
          <th>Tiempo en espera</th>
          <th>Encargado</th>
          <th>Fecha Asignaci√≥n</th>
          <th>Acci√≥n</th>
          <th>Editar</th>
          <th>Eliminar</th>
        </tr>
      </thead>
      <tbody id="cuerpoTabla"></tbody>
    </table>
  </div>

  <div class="modal" id="modal">
    <div class="modal-content">
      <h3>Confirmar acci√≥n</h3>
      <p>Selecciona tu nombre:</p>
      <select id="selectorEncargado">
        <option value="">Seleccionar</option>
        <option value="Cristopher">Cristopher</option>
        <option value="Marcela">Marcela</option>
        <option value="Yare">Yare</option>
        <option value="Yuliana">Yuliana</option>
        <option value="Tatiana">Tatiana</option>
        <option value="Geansury">Geansury</option>
      </select>
      <button onclick="confirmarAsignacion()">Confirmar</button>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDUEZgkW-3HbZu2BLej4v0mbDHZf2vRo8",
      authDomain: "tours-460717.firebaseapp.com",
      projectId: "tours-460717"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    function abrirModalAsignacion(id) {
      document.getElementById('modal').style.display = 'flex';
      document.getElementById('modal').dataset.id = id;
    }

    function confirmarAsignacion() {
      const id = document.getElementById('modal').dataset.id;
      const encargado = document.getElementById('selectorEncargado').value;
      if (!encargado) return alert("Selecciona tu nombre");
      db.collection("solicitudes").doc(id).update({
        estado: "En Proceso",
        encargado: encargado,
        fecha_asignacion: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        alert("Cotizaci√≥n asignada a " + encargado);
        document.getElementById('modal').style.display = 'none';
        cargarSolicitudes();
      });
    }

    function editarSolicitud(id, data) {
      document.getElementById("telefono").value = data.telefono;
      document.getElementById("destino").value = data.destino;
      document.getElementById("fechas").value = data.fechas;
      document.getElementById("adultos").value = data.adultos;
      document.getElementById("ninos").value = data.ninos;
      document.getElementById("observaciones").value = data.observaciones;
      document.getElementById("embajador").value = data.embajador;
      document.getElementById("formularioSolicitud").onsubmit = function(e) {
        e.preventDefault();
        db.collection("solicitudes").doc(id).update({
          telefono: document.getElementById("telefono").value,
          destino: document.getElementById("destino").value,
          fechas: document.getElementById("fechas").value,
          adultos: parseInt(document.getElementById("adultos").value),
          ninos: parseInt(document.getElementById("ninos").value),
          observaciones: document.getElementById("observaciones").value,
          embajador: document.getElementById("embajador").value
        }).then(() => {
          alert("Solicitud actualizada.");
          document.getElementById("formularioSolicitud").reset();
          document.getElementById("formularioSolicitud").onsubmit = enviarNuevaSolicitud;
          cargarSolicitudes();
        });
      };
    }

    function eliminarSolicitud(id) {
      if (!confirm("¬øEliminar esta solicitud?")) return;
      db.collection("solicitudes").doc(id).delete().then(() => {
        alert("Eliminado correctamente.");
        cargarSolicitudes();
      });
    }

    function cargarSolicitudes() {
      db.collection("solicitudes").orderBy("registro", "desc").get().then(snapshot => {
        const tbody = document.getElementById("cuerpoTabla");
        tbody.innerHTML = "";
        snapshot.forEach(doc => {
          const data = doc.data();
          const tiempoEnMinutos = data.estado === "Pendiente" ? Math.floor((Date.now() - data.registro.toDate()) / 60000) + " min" : "-";
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${data.numero}</td>
            <td>${data.telefono}</td>
            <td>${data.destino}</td>
            <td>${data.fechas}</td>
            <td>${data.adultos}</td>
            <td>${data.ninos}</td>
            <td>${data.observaciones || "-"}</td>
            <td>${data.embajador}</td>
            <td><span class="${data.estado === 'Pendiente' ? 'estado-pendiente' : 'estado-proceso'}">${data.estado}</span></td>
            <td>${data.registro.toDate().toLocaleString()}</td>
            <td>${tiempoEnMinutos}</td>
            <td>${data.encargado || "-"}</td>
            <td>${data.fecha_asignacion ? data.fecha_asignacion.toDate().toLocaleString() : "-"}</td>
            <td>${data.estado === 'Pendiente' ? `<button class='btn-cotizar' onclick='abrirModalAsignacion("${doc.id}")'>Tomar</button>` : '-'}</td>
            <td>${data.estado === 'Pendiente' ? `<button onclick='editarSolicitud("${doc.id}", ${JSON.stringify(data).replace(/'/g, "\'")})'>‚úèÔ∏è</button>` : '-'}</td>
            <td>${data.estado === 'Pendiente' ? `<button onclick='eliminarSolicitud("${doc.id}")'>üóëÔ∏è</button>` : '-'}</td>
          `;
          tbody.appendChild(row);
        });
      });
    }

    function enviarNuevaSolicitud(e) {
      e.preventDefault();
      const numero = `COT-${Date.now()}`;
      const data = {
        numero,
        telefono: document.getElementById("telefono").value,
        destino: document.getElementById("destino").value,
        fechas: document.getElementById("fechas").value,
        adultos: parseInt(document.getElementById("adultos").value),
        ninos: parseInt(document.getElementById("ninos").value),
        observaciones: document.getElementById("observaciones").value,
        embajador: document.getElementById("embajador").value,
        estado: "Pendiente",
        encargado: "-",
        registro: firebase.firestore.Timestamp.now(),
        fecha_asignacion: null
      };
      db.collection("solicitudes").add(data).then(() => {
        alert("Guardado con √©xito.");
        document.getElementById("formularioSolicitud").reset();
        cargarSolicitudes();
      });
    }

    document.getElementById("formularioSolicitud").addEventListener("submit", enviarNuevaSolicitud);
    window.onload = cargarSolicitudes;
  </script>

</body>
</html>


