<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Detalle de Cotizaci√≥n</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f7f7;
      padding: 20px;
    }
    h1 {
      color: #02535a;
      text-align: center;
    }
    h2 {
      background-color: #02535a;
      color: white;
      padding: 10px;
      border-radius: 5px;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    input, textarea, select {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    section {
      margin-bottom: 30px;
      padding: 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
#btn-guardar {
  background-color: #28a745; /* Verde */
  color: white;
  font-weight: bold;
  padding: 12px 24px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  margin-top: 10px;
  transition: background-color 0.3s ease;
}
#btn-guardar:hover {
  background-color: #218838; /* Verde m√°s oscuro al pasar el mouse */
}
#incluye,
#itinerario,
#info_hotel,
#tours_opcionales,
#politicas {
  height: 400px; /* Puedes aumentar a 200px si a√∫n no es suficiente */
  resize: vertical; /* Opcional: permite que el usuario ajuste si quiere */
}
  </style>
</head>
<body>
  <h1 id="titulo-cotizacion">Detalle de Cotizaci√≥n</h1>

  <section>
    <h2>Informaci√≥n de la Solicitud</h2>
    <label>Tel√©fono</label>
    <input id="telefono" ></textarea>

    <label>Destino</label>
    <select id="destino" onchange="cargarDatosDelTour()"></select>

    <label>Fechas del viaje</label>
    <input id="fechas" />

    <label>Adultos</label>
    <input id="adultos" type="number" />

    <label>Ni√±os</label>
    <input id="ninos" type="number" />

    <label>Beb√©s</label>
    <input id="bebes" type="number" />

    <label>Observaciones</label>
    <textarea id="observaciones"></textarea>
  </section>

  <section>
    <h2>Informaci√≥n del Tour</h2>
    <label>Duraci√≥n</label>
    <input id="duracion" ></textarea>

    <label>Incluye</label>
    <textarea id="incluye" ></textarea>

    <label>No incluye</label>
    <textarea id="no_incluye" ></textarea>

    <label>Itinerario</label>
    <textarea id="itinerario" ></textarea>
  </section>
<section>
  <h2>Vuelo y Hotel</h2>
  <label>Aerol√≠nea</label>
  <select id="aerolinea">
    <option value="">-- Seleccione una aerol√≠nea --</option>
    <option value="Avianca">Avianca</option>
    <option value="Copa Airlines">Copa Airlines</option>
    <option value="Volaris">Volaris</option>
    <option value="Wingo">Wingo</option>
  </select>

  <label>Vuelo de Ida</label>
  <textarea id="vuelo_ida"></textarea>

  <label>Vuelo de Regreso</label>
  <textarea id="vuelo_vuelta"></textarea>

  <label>Equipaje</label>
  <label>Tipo de Equipaje</label>
  <select id="tipo_equipaje">
    <option value="">-- Seleccionar --</option>
    <option value="Art√≠culo personal">Art√≠culo personal (bolso de espalda)</option>
    <option value="Maleta de mano">Maleta de mano 10kg</option>
    <option value="Maleta documentada">Maleta documentada 23kg</option>
  </select>

  <label>Cantidad</label>
  <input type="number" id="cantidad_equipaje" placeholder="Ej. 2" min="1" />

  <label>Uso</label>
  <select id="uso_equipaje">
    <option value="">-- Seleccionar --</option>
    <option value="por persona">Por persona</option>
    <option value="compartido">Compartido</option>
  </select>

  <button type="button" onclick="agregarEquipaje()" style="margin-top:10px; background-color:#02535a; color:white; padding:8px 16px; border:none; border-radius:5px;">‚ûï Agregar equipaje</button>

  <label style="margin-top: 15px;">Resumen de Equipaje</label>
  <textarea id="equipaje" readonly rows="5" placeholder="Aqu√≠ aparecer√°n los tipos de equipaje agregados."></textarea>

  <label>Hotel</label>
  <select id="hotel"></select>

  <label>Informaci√≥n del Hotel</label>
  <textarea id="info_hotel"></textarea>
</section>

<section>
  <h2>Inversi√≥n por Viajero</h2>
<p style="font-style: italic; color: #555;">Todos los precios est√°n expresados en d√≥lares estadounidenses $ (USD)</p>
<label>Precio por Adulto</label>
<input type="number" id="precio_adulto" step="0.01" oninput="calcularTotal()" />

<label>Precio por Ni√±o</label>
<input type="number" id="precio_nino" step="0.01" oninput="calcularTotal()" />

<label>Precio por Beb√©</label>
<input type="number" id="precio_bebe" step="0.01" oninput="calcularTotal()" />

<label>Total General</label>
<input type="number" id="total_general" step="0.01" readonly />

<label>Monto de Reserva por Persona</label>
<input type="number" id="monto_reserva" step="0.01" />
</section>

<section>
  <h2>Tours Opcionales</h2>
  <textarea id="tours_opcionales"></textarea>
</section>

<section>
  <h2>Pol√≠ticas y Condiciones Generales</h2>
  <textarea id="politicas"></textarea>
</section>

<!-- Agrega bot√≥n de guardar si a√∫n no lo tienes -->
<button onclick="guardarCotizacion()" id="btn-guardar">üíæ Guardar Cotizaci√≥n</button>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
 
<script>

  const firebaseConfig = {
    apiKey: "AIzaSyDUEZgkW-3HbZu2BLej4v0mbDHZf2vRo8",
    authDomain: "tours-460717.firebaseapp.com",
    projectId: "tours-460717"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let cargadoDesdeFormal = false;
let hotelGuardado = null;
  const params = new URLSearchParams(window.location.search);
  const codigo = params.get("codigo");

  document.getElementById("titulo-cotizacion").textContent = `Detalle de Cotizaci√≥n ${codigo}`;

  async function cargarDatosIniciales() {
    await cargarOpcionesDeDestino();
    const docFormal = await db.collection("cotizacionformal").doc(codigo).get();
    if (docFormal.exists) {
      cargadoDesdeFormal = true;
      rellenarCampos(docFormal.data());
      cargarDatosDelTour();
      return;
    }
   const docSolicitud = await db.collection("solicitud_cotizaciones").doc(codigo).get();
if (!docSolicitud.exists) return alert("‚ùå No se encontr√≥ la solicitud de cotizaci√≥n.");

rellenarCampos(docSolicitud.data());
}
  async function cargarOpcionesDeDestino() {
    const destinosSnap = await db.collection("tours").get();
    const select = document.getElementById("destino");
    select.innerHTML = "<option value=''>-- Seleccione un destino --</option>";
    destinosSnap.forEach(doc => {
      const opt = document.createElement("option");
      opt.value = doc.data().nombre;
      opt.textContent = doc.data().nombre;
      select.appendChild(opt);
  });
  }
  async function cargarDatosDelTour() {
    const destino = document.getElementById("destino").value;
    if (!destino || (cargadoDesdeFormal && hotelGuardado)) return;

    const snap = await db.collection("tours").where("nombre", "==", destino).get();
    if (snap.empty) return;

    const data = snap.docs[0].data();
    document.getElementById("duracion").value = data.duracion || "";
    document.getElementById("incluye").value = data.incluye || "";
    document.getElementById("no_incluye").value = data.no_incluye || "";
    document.getElementById("itinerario").value = data.itinerario_tours || "";
    document.getElementById("tours_opcionales").value = data.tours_opcionales || "";
    document.getElementById("politicas").value = data.politicas || "";

    const hotelSelect = document.getElementById("hotel");
    hotelSelect.innerHTML = "<option value=''>-- Seleccione un hotel --</option>";
   const hoteles = Object.values(data.hoteles || {});
    hoteles.forEach(h => {
      const opt = document.createElement("option");
      opt.value = h.nombre;
      opt.textContent = h.nombre;
      hotelSelect.appendChild(opt);
    });
    hotelSelect.onchange = () => {
      const seleccionado = hoteles.find(h => h.nombre === hotelSelect.value);
      document.getElementById("info_hotel").value = seleccionado?.info || "";
}
    if (data.hotel) {
  hotelSelect.value = data.hotel;
  const seleccionado = hoteles.find(h => h.nombre === data.hotel);
  document.getElementById("info_hotel").value = seleccionado?.info || "";
};
  }

function rellenarCampos(data) {
    for (const key in data) {
      const campo = document.getElementById(key);
      if (campo) campo.value = data[key];
  }
 if (data.hotel) {
    hotelGuardado = {
      nombre: data.hotel,
      info: data.info_hotel || ""
    };

    const hotelSelect = document.getElementById("hotel");
    hotelSelect.innerHTML = `<option value="${hotelGuardado.nombre}">${hotelGuardado.nombre}</option>`;
    hotelSelect.value = hotelGuardado.nombre;

    document.getElementById("info_hotel").value = hotelGuardado.info;
  }

  cargarDatosDelTour(); // se ejecuta despu√©s para evitar sobreescribir
}

  function calcularTotal() {
    const a = parseFloat(document.getElementById("precio_adulto").value) || 0;
    const n = parseFloat(document.getElementById("precio_nino").value) || 0;
    const b = parseFloat(document.getElementById("precio_bebe").value) || 0;
    const ca = parseInt(document.getElementById("adultos").value) || 0;
    const cn = parseInt(document.getElementById("ninos").value) || 0;
    const cb = parseInt(document.getElementById("bebes").value) || 0;
    document.getElementById("total_general").value = (a * ca + n * cn + b * cb).toFixed(2);
  }

 async function guardarCotizacion() {
  const data = {
    telefono: document.getElementById("telefono").value,
    destino: document.getElementById("destino").value,
    fechas: document.getElementById("fechas").value,
    adultos: parseInt(document.getElementById("adultos").value) || 0,
    ninos: parseInt(document.getElementById("ninos").value) || 0,
    bebes: parseInt(document.getElementById("bebes").value) || 0,
    observaciones: document.getElementById("observaciones").value,

    duracion: document.getElementById("duracion").value,
    incluye: document.getElementById("incluye").value,
    no_incluye: document.getElementById("no_incluye").value,
    itinerario: document.getElementById("itinerario").value, // ‚úÖ nombre corregido

    aerolinea: document.getElementById("aerolinea").value,
    vuelo_ida: document.getElementById("vuelo_ida").value,
    vuelo_vuelta: document.getElementById("vuelo_vuelta").value,
    equipaje: document.getElementById("equipaje").value,
    hotel: document.getElementById("hotel").value,
    info_hotel: document.getElementById("info_hotel").value,

    precio_adulto: parseFloat(document.getElementById("precio_adulto").value) || 0,
    precio_nino: parseFloat(document.getElementById("precio_nino").value) || 0,
    precio_bebe: parseFloat(document.getElementById("precio_bebe").value) || 0,
    total_general: parseFloat(document.getElementById("total_general").value) || 0,
    monto_reserva: parseFloat(document.getElementById("monto_reserva").value) || 0,

    tours_opcionales: document.getElementById("tours_opcionales").value,
    politicas: document.getElementById("politicas").value,
    timestamp: new Date()
  };

  try {
    await db.collection("cotizacionformal").doc(codigo).set(data, { merge: true });
    alert("‚úÖ Cotizaci√≥n guardada correctamente.");
  } catch (err) {
    console.error("‚ùå Error al guardar:", err);
    alert("‚ùå No se pudo guardar.");
  }
}
function agregarEquipaje() {
  const tipo = document.getElementById("tipo_equipaje").value;
  const cantidad = document.getElementById("cantidad_equipaje").value;
  const uso = document.getElementById("uso_equipaje").value;
  const textarea = document.getElementById("equipaje");

  if (!tipo || !cantidad || !uso) {
    alert("Por favor completa los tres campos antes de agregar el equipaje.");
    return;
  }

  const linea = `${cantidad} ${tipo.toLowerCase()}(s) ${uso}`;
  textarea.value += (textarea.value ? '\n' : '') + linea;

  // Limpiar campos
  document.getElementById("tipo_equipaje").value = "";
  document.getElementById("cantidad_equipaje").value = "";
  document.getElementById("uso_equipaje").value = "";
}
function ajustarAlturaTextareas() {
  document.querySelectorAll("textarea").forEach(textarea => {
    textarea.style.height = "auto";
    textarea.style.height = textarea.scrollHeight + "px";
  });
}

  window.onload = cargarDatosIniciales;

  </script>

</body>
</html>
